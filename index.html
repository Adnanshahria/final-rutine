<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Last Fight (v3.2 - Final Cleaned)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --color-bg-main: #0f172a; --color-bg-card: #1e293b; --color-bg-header: #334155;
            --color-bg-hover: #475569; --color-bg-dropdown: #293548; --color-border: #475569;
            --color-border-light: #64748b; --color-text-main: #f1f5f9; --color-text-dim: #94a3b8;
            --color-accent-green: #22c55e; --color-accent-blue: #3b82f6; --color-accent-red: #ef4444;
            --color-accent-yellow: #eab308; --color-accent-gold: #f59e0b; --color-accent-orange: #f97316;
            --color-accent-purple: #8b5cf6; --color-accent-pink: #ec4899; --color-accent-cyan: #06b6d4;
            --color-blue-400: #60a5fa; --color-green-400: #4ade80; --color-red-900: #7f1d1d;
            --color-red-500-t: rgba(239, 68, 68, 0.1); --color-blue-700-t: rgba(29, 78, 216, 0.3);
            --color-green-700-t: rgba(21, 128, 61, 0.3);
        }
        body { font-family: 'Inter', sans-serif; overscroll-behavior: none; background-color: var(--color-bg-main); color: var(--color-text-main); }
        ::-webkit-scrollbar { width: 8px; height: 8px; } ::-webkit-scrollbar-track { background: var(--color-bg-main); } ::-webkit-scrollbar-thumb { background: var(--color-border); border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: var(--color-border-light); }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .modern-button { padding: 0.6rem 1.1rem; border-radius: 8px; font-weight: 600; transition: all 0.2s ease; cursor: pointer; border: none; }
        .button-primary { background-color: var(--color-accent-blue); color: white; } .button-primary:hover { background-color: #2563eb; }
        .button-secondary { background-color: var(--color-bg-header); color: var(--color-text-main); } .button-secondary:hover { background-color: var(--color-border); }
        .button-danger { background-color: var(--color-accent-red); color: white; } .button-danger:hover { background-color: #dc2626; }
        .button-success { background-color: var(--color-accent-green); color: white; } .button-success:hover { background-color: #16a34a; }
        .priority-indicator { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; margin-right: 6px; }
        .priority-high { background-color: var(--color-accent-red); box-shadow: 0 0 6px var(--color-accent-red); }
        .priority-medium { background-color: var(--color-accent-yellow); box-shadow: 0 0 6px var(--color-accent-yellow); }
        .priority-low { background-color: var(--color-border); }
        .study-status { font-size: 0.6rem; font-weight: 700; text-transform: uppercase; padding: 0.15rem 0.4rem; border-radius: 4px; margin-left: 0.5rem; flex-shrink: 0; line-height: 1; border: 1px solid; white-space: nowrap; }
        .study-mqb { border-color: var(--color-accent-orange); color: var(--color-accent-orange); background-color: rgba(249, 115, 22, 0.1); }
        .study-ret { border-color: var(--color-accent-cyan); color: var(--color-accent-cyan); background-color: rgba(6, 182, 212, 0.1); }
        .study-med { border-color: var(--color-accent-pink); color: var(--color-accent-pink); background-color: rgba(236, 72, 153, 0.1); }
        .study-camp { border-color: var(--color-accent-purple); color: var(--color-accent-purple); background-color: rgba(139, 92, 246, 0.1); }
        .study-week { border-color: var(--color-accent-yellow); color: var(--color-accent-yellow); background-color: rgba(234, 179, 8, 0.1); }
        .study-rev { border-color: var(--color-accent-green); color: var(--color-accent-green); background-color: rgba(34, 197, 94, 0.1); }
        .study-new { border-color: var(--color-accent-blue); color: var(--color-accent-blue); background-color: rgba(59, 130, 246, 0.1); }
        .progress-box { display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.7rem; cursor: pointer; user-select: none; transition: all 0.2s ease-in-out; color: white; border-radius: 8px; width: 40px; min-width: 40px; max-width: 40px; height: 40px; flex-shrink: 0; box-sizing: border-box; border: 1px solid rgba(255, 255, 255, 0.1); position: relative; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.2), inset 0 1px 1px rgba(255,255,255,0.1); }
        .progress-box::before { content: ''; position: absolute; inset: 0; border-radius: 7px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); z-index: 1; }
        .progress-box span { position: relative; z-index: 2; }
        .progress-0 { background-color: var(--color-border); } .progress-20 { background-color: var(--color-accent-red); } .progress-40 { background-color: var(--color-accent-orange); } .progress-60 { background-color: var(--color-accent-yellow); } .progress-80 { background-color: var(--color-accent-blue); } .progress-100 { background-color: var(--color-accent-green); }
        .progress-box:hover { transform: translateY(-1px) scale(1.03); box-shadow: 0 5px 10px rgba(0,0,0,0.3), inset 0 1px 1px rgba(255,255,255,0.1); } .progress-box:active { transform: translateY(0px) scale(1); }
        .topic-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem 0.5rem; border-radius: 8px; transition: background-color 0.2s; border-bottom: 1px solid var(--color-bg-header); }
        .topic-item:last-child { border-bottom: none; } .topic-item:hover { background-color: rgba(255, 255, 255, 0.03); }
        .topic-name { flex-grow: 1; font-weight: 500; color: var(--color-text-main); white-space: normal; word-break: break-word; display: flex; align-items: center; }
        .topic-name-text {}
        .edit-icon { flex-shrink: 0; color: var(--color-text-dim); cursor: pointer; padding: 5px; border-radius: 50%; transition: background-color 0.2s, color 0.2s; background: none; border: none; }
        .edit-icon:hover { background-color: var(--color-border); color: white; } .edit-icon.has-note { color: var(--color-accent-yellow); } .edit-icon.has-note:hover { color: #fde047; }
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(120%); padding: 12px 20px; border-radius: 8px; font-weight: 600; display: flex; align-items: center; gap: 10px; z-index: 100; transition: opacity 0.3s, transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); opacity: 0; background-color: var(--color-bg-card); border: 1px solid var(--color-border); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        @media (min-width: 768px) { #toast { left: auto; right: 20px; transform: translateY(120%); } #toast.show { transform: translateY(0); } }
        .spinner { width: 18px; height: 18px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; } @keyframes spin { to { transform: rotate(360deg); } }
        .topic-item.dragging { opacity: 0.5; background: var(--color-bg-header); transform: scale(1.02); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .column-section.drag-over { border: 2px dashed var(--color-accent-blue); background-color: rgba(59, 130, 246, 0.05); border-radius: 8px; margin: -2px; padding-bottom: 0.5rem; }
        [contenteditable="true"] { -webkit-user-modify: read-write-plaintext-only; }
        [contenteditable="true"]:empty:before { content: attr(placeholder); color: var(--color-text-dim); opacity: 0.7; pointer-events: none; display: block; }
        [contenteditable="true"]:focus { outline: 2px solid var(--color-accent-blue); border-radius: 4px; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); background-color: rgba(59, 130, 246, 0.1); }
        .date-card { background-color: var(--color-bg-card); border: 1px solid var(--color-border); border-radius: 12px; margin-bottom: 1.5rem; overflow: hidden; position: relative; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.15), 0 2px 4px -2px rgba(0, 0, 0, 0.1); transition: box-shadow 0.2s ease; }
        .date-card:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -4px rgba(0, 0, 0, 0.1); }
        .date-header { background-color: var(--color-bg-header); padding: 0.75rem 1.25rem; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap; }
        .date-header-text { font-size: 1.125rem; font-weight: 700; color: white; background-color: var(--color-blue-700-t); padding: 0.35rem 0.75rem; margin: -0.25rem 0; border-radius: 6px; border: 1px solid var(--color-accent-blue); box-shadow: 0 1px 2px rgba(0,0,0,0.2); flex-shrink: 0; transition: background-color 0.2s; }
        .date-header-text:focus { background-color: rgba(29, 78, 216, 0.5); }
        .card-progress-container { flex-grow: 1; display: flex; align-items: center; gap: 0.75rem; min-width: 150px; }
        .card-progress-text { font-size: 0.875rem; font-weight: 600; color: var(--color-text-main); flex-shrink: 0; }
        .card-progress-bar-bg { width: 100%; height: 8px; background-color: var(--color-bg-main); border-radius: 4px; overflow: hidden; box-shadow: inset 0 1px 2px rgba(0,0,0,0.3); }
        .card-progress-bar-fg { height: 100%; background-color: var(--color-accent-blue); border-radius: 4px; transition: width 0.3s ease-out; }
        .card-progress-count { font-size: 0.75rem; font-weight: 500; color: var(--color-text-dim); background-color: var(--color-bg-main); padding: 0.1rem 0.5rem; border-radius: 4px; white-space: nowrap; }
        .column-section { padding: 0.75rem 1.25rem 1rem; border-bottom: 1px solid var(--color-border); } .column-section:last-child { border-bottom: none; }
        .column-title { display: inline-block; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; padding: 0.25rem 0.6rem; border-radius: 6px; margin-bottom: 0.75rem; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .date-card[data-table-id="table1"] .column-title { background-color: var(--color-green-700-t); color: var(--color-green-400); border: 1px solid var(--color-accent-green); }
        .date-card[data-table-id="table2"] .column-title { background-color: var(--color-blue-700-t); color: var(--color-blue-400); border: 1px solid var(--color-accent-blue); }
        .delete-row-btn { color: var(--color-text-dim); opacity: 0.6; transition: all 0.2s ease; padding: 0.35rem; border-radius: 50%; flex-shrink: 0; background: none; border: none; cursor: pointer;}
        .delete-row-btn:hover { color: var(--color-accent-red); opacity: 1; transform: scale(1.1); background-color: var(--color-red-500-t); }
        .card-footer { padding: 0.75rem 1.25rem; background-color: rgba(0,0,0,0.1); border-top: 1px solid var(--color-border); }
        .add-topic-btn-card-single { width: 100%; text-align: center; font-size: 0.875rem; color: var(--color-text-dim); padding: 0.6rem; border: 2px dashed var(--color-border); border-radius: 8px; transition: all 0.2s; font-weight: 600; background: none; cursor: pointer; }
        .add-topic-btn-card-single:hover { color: var(--color-blue-400); border-color: var(--color-blue-500); background-color: rgba(59, 130, 246, 0.1); }
        .view-toggle-btn { padding: 0.6rem 1.2rem; font-weight: 600; color: var(--color-text-dim); border-bottom: 3px solid transparent; transition: color 0.2s, border-color 0.2s; margin-bottom: -1px; background: none; border-top: none; border-left: none; border-right: none; cursor: pointer; }
        .view-toggle-btn.active { color: var(--color-accent-blue); border-bottom-color: var(--color-accent-blue); }
        .view-toggle-btn:hover:not(.active) { color: var(--color-text-main); }
        .priority-btn { display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.8rem; border: 1px solid var(--color-border); border-radius: 6px; font-weight: 500; color: var(--color-text-dim); transition: all 0.2s; background-color: var(--color-bg-header); cursor: pointer; }
        .priority-btn .priority-indicator { margin-right: 0; }
        .priority-btn:hover { background-color: var(--color-border); color: var(--color-text-main); }
        .priority-btn.active { color: var(--color-text-main); font-weight: 600; background-color: var(--color-bg-hover); }
        .priority-btn[data-priority="high"].active { border-color: var(--color-accent-red); box-shadow: 0 0 5px rgba(239, 68, 68, 0.3); background-color: var(--color-red-500-t); }
        .priority-btn[data-priority="medium"].active { border-color: var(--color-accent-yellow); box-shadow: 0 0 5px rgba(234, 179, 8, 0.3); background-color: rgba(234, 179, 8, 0.1); }
        .priority-btn[data-priority="low"].active { border-color: var(--color-border-light); background-color: var(--color-border); }
        .modal-backdrop { position: fixed; inset: 0; z-index: 40; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; padding: 1rem; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-backdrop.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--color-bg-card); border: 1px solid var(--color-border-light); border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4); width: 100%; max-width: 550px; padding: 1.75rem; transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .modal-backdrop.show .modal-content { transform: scale(1); }
        #confirm-modal .modal-content { max-width: 400px; } #calendar-modal .modal-content { max-width: 400px; }
        .custom-dropdown { position: relative; }
        .custom-dropdown-button { display: flex; align-items: center; justify-content: space-between; width: 100%; background-color: var(--color-bg-header); border: 1px solid var(--color-border); border-radius: 8px; padding: 0.6rem 0.8rem; color: var(--color-text-main); transition: border-color 0.2s, box-shadow 0.2s; cursor: pointer; text-align: left; }
        .custom-dropdown-button:focus, .custom-dropdown-button.active { outline: none; border-color: var(--color-accent-blue); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        .custom-dropdown-button .arrow { width: 1em; height: 1em; margin-left: 0.5rem; transition: transform 0.2s; color: var(--color-text-dim); }
        .custom-dropdown-button.active .arrow { transform: rotate(180deg); }
        .custom-dropdown-options { position: absolute; top: calc(100% + 4px); left: 0; right: 0; z-index: 10; background-color: var(--color-bg-dropdown); border: 1px solid var(--color-border-light); border-radius: 8px; max-height: 200px; overflow-y: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.3); opacity: 0; visibility: hidden; transform: translateY(-10px); transition: opacity 0.2s, visibility 0.2s, transform 0.2s; }
        .custom-dropdown-options.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .custom-dropdown-option { padding: 0.6rem 0.8rem; cursor: pointer; color: var(--color-text-main); transition: background-color 0.15s; border-bottom: 1px solid var(--color-border); }
        .custom-dropdown-option:last-child { border-bottom: none; }
        .custom-dropdown-option:hover { background-color: var(--color-bg-hover); }
        .custom-dropdown-option.selected { background-color: var(--color-accent-blue); color: white; font-weight: 600; }
        #calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        #calendar-month-year { font-size: 1.125rem; font-weight: 600; color: var(--color-text-main); }
        #calendar-header button { background: var(--color-bg-header); border: 1px solid var(--color-border); border-radius: 50%; width: 34px; height: 34px; display: flex; justify-content: center; align-items: center; transition: background-color 0.2s; cursor: pointer; }
        #calendar-header button:hover { background: var(--color-border); } #calendar-header button svg { color: var(--color-text-dim); }
        #calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 0.5rem; }
        #calendar-weekdays div { text-align: center; font-size: 0.75rem; font-weight: 600; color: var(--color-text-dim); }
        #calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { background: var(--color-bg-header); border: 1px solid var(--color-border); border-radius: 6px; text-align: center; padding: 0.5rem 0; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; }
        .calendar-day:hover:not(.disabled):not(.empty) { background: var(--color-border); }
        .calendar-day.empty { background: transparent; border-color: transparent; cursor: default; }
        .calendar-day.today { border-color: var(--color-accent-yellow); color: var(--color-accent-yellow); font-weight: 700; }
        .calendar-day.selected { background: var(--color-accent-blue); border-color: var(--color-accent-blue); color: white; font-weight: 700; }
        .calendar-day.disabled { background: var(--color-bg-card); color: var(--color-text-dim); opacity: 0.5; cursor: not-allowed; border-color: transparent; }
        @keyframes pulse-gold { 0%, 100% { text-shadow: 0 0 5px rgba(245, 158, 11, 0.4); } 50% { text-shadow: 0 0 15px rgba(245, 158, 11, 0.8); } }
        #countdown-card { background-image: linear-gradient(100deg, var(--color-red-900) 0%, #1e1b1b 100%); border: 1px solid var(--color-accent-red); border-radius: 10px; box-shadow: 0 0 15px rgba(239, 68, 68, 0.1), 0 4px 10px rgba(0,0,0,0.3); padding: 0.7rem 1.2rem; display: flex; align-items: center; gap: 1.5rem; }
        #countdown-card h3 { color: white; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; font-size: 0.8rem; margin: 0; text-shadow: 0 1px 2px rgba(0,0,0,0.5); writing-mode: vertical-lr; transform: rotate(180deg); border-right: 1px solid var(--color-border); padding-right: 0.8rem; margin-right: -0.8rem; }
        #countdown { display: flex; gap: 1rem; }
        .countdown-segment { text-align: center; }
        .countdown-segment span:first-child { font-family: 'Courier New', Courier, monospace; display: block; font-size: 1.8rem; line-height: 1; font-weight: 700; color: var(--color-accent-gold); animation: pulse-gold 2s infinite ease-in-out; }
        .countdown-segment span:last-child { color: var(--color-text-dim); font-weight: 600; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 3px; display: block; }
        .add-row-button { margin-top: 1rem; width: 100%; font-size: 1rem; color: var(--color-text-dim); font-semibold; padding: 0.75rem; border: 2px dashed var(--color-border); border-radius: 10px; transition: all 0.2s; background: none; cursor: pointer; }
        .add-row-button:hover { color: var(--color-text-main); border-color: var(--color-border-light); background-color: rgba(255, 255, 255, 0.03); }
        #open-calendar-btn { color: var(--color-blue-400); border-color: var(--color-accent-blue); background-color: var(--color-blue-700-t); }
        #open-calendar-btn:hover { color: white; border-color: var(--color-blue-400); background-color: rgba(59, 130, 246, 0.2); }
    </style>
</head>
<body ondragover="event.preventDefault()">

    <div class="max-w-7xl mx-auto px-4 md:px-8 pt-6 md:pt-8">
        <div class="flex flex-col md:flex-row justify-between md:items-center gap-6 mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white text-center md:text-left font-sans">
                Last Fight <span class="text-green-400">Tracker</span>
            </h1>
            <div class="flex justify-center md:justify-end w-full md:w-auto">
                <div id="countdown-card">
                    <h3>Countdown</h3>
                    <div id="countdown">
                        <div class="countdown-segment"><span id="days">00</span><span class="block">Days</span></div>
                        <div class="countdown-segment"><span id="hours">00</span><span class="block">Hours</span></div>
                        <div class="countdown-segment"><span id="minutes">00</span><span class="block">Mins</span></div>
                        <div class="countdown-segment"><span id="seconds">00</span><span class="block">Secs</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-slate-800 p-5 rounded-lg card-shadow border border-slate-700">
                <div class="flex justify-between items-center mb-2"> <span class="text-lg font-semibold text-white">Overall Progress (Targets)</span> <span id="overall-progress-text" class="text-lg font-bold text-green-400">0%</span> </div>
                <div class="w-full bg-slate-700 rounded-full h-4 overflow-hidden card-shadow"> <div id="overall-progress-bar" class="bg-green-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div> </div>
                <div class="text-right mt-1"> <span id="t1_task_counter" class="bg-green-700/30 text-green-300 text-xs font-semibold px-2 py-0.5 rounded-full opacity-0 transition-opacity">0 / 0 Done</span> </div>
            </div>
            <div class="bg-slate-800 p-5 rounded-lg card-shadow border border-slate-700">
                <div class="flex justify-between items-center mb-2"> <span class="text-lg font-semibold text-white">Daily Progress (Plan)</span> <span id="t2-overall-progress-text" class="text-lg font-bold text-blue-400">0%</span> </div>
                <div class="w-full bg-slate-700 rounded-full h-4 overflow-hidden card-shadow"> <div id="t2-overall-progress-bar" class="bg-blue-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div> </div>
                 <div class="text-right mt-1"> <span id="t2_task_counter" class="bg-blue-700/30 text-blue-300 text-xs font-semibold px-2 py-0.5 rounded-full opacity-0 transition-opacity">0 / 0 Done</span> </div>
            </div>
        </div>

        <div class="mb-8 border-b border-slate-700 flex justify-center md:justify-start">
            <button id="view-toggle-table1" class="view-toggle-btn active" data-view="table1">Targets</button>
            <button id="view-toggle-table2" class="view-toggle-btn" data-view="table2">Daily Plan View</button>
        </div>

        <div id="loading" class="text-center py-20"> <div class="spinner" style="margin: 0 auto; width: 40px; height: 40px; border-width: 4px;"></div> <p class="mt-4 text-lg text-slate-400">Loading Dashboard...</p> </div>
        <div id="content" class="hidden pb-8">
            <div id="main-content-area">
                <div id="table1-section" class="mb-10"> <div id="table1-cards"></div> <button id="add-row-t1" class="add-row-button">+ Add "New Date" Card</button> </div>
                <div id="table2-section" class="mb-10 hidden"> <div id="table2-cards"></div> <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> <button id="open-calendar-btn" class="add-row-button">Add Card by Date</button> <button id="add-row-t2" class="add-row-button">+ Add "New Date" Card</button> </div> </div>
            </div>
        </div>
    </div>

    <div id="toast"> <div id="toast-spinner" class="spinner"></div> <span id="toast-message">Syncing...</span> </div>

    <div id="add-topic-modal" class="modal-backdrop">
        <div class="modal-content">
             <h3 class="text-xl font-semibold mb-6 text-white">Add New Topic</h3>
            <div class="mb-5">
                <label for="add-topic-modal-name" class="block text-sm font-medium text-slate-300 mb-1">Topic Name</label>
                <input type="text" id="add-topic-modal-name" class="w-full p-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1">Hardness</label>
                    <div class="custom-dropdown" data-target-input="add-topic-modal-hardness-value">
                        <button type="button" class="custom-dropdown-button"> <span class="selected-value">Medium</span> <svg class="arrow w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 8l4 4 4-4"/></svg> </button>
                        <div class="custom-dropdown-options"> <div class="custom-dropdown-option" data-value="easy">Easy</div> <div class="custom-dropdown-option selected" data-value="medium">Medium</div> <div class="custom-dropdown-option" data-value="hard">Hard</div> </div>
                        <input type="hidden" id="add-topic-modal-hardness-value" value="medium">
                    </div>
                </div>
                <div id="add-topic-targets-fields">
                    <label class="block text-sm font-medium text-slate-300 mb-1">Subject</label>
                    <div class="custom-dropdown" data-target-input="add-topic-modal-subject-value">
                        <button type="button" class="custom-dropdown-button"> <span class="selected-value">Phy</span> <svg class="arrow w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 8l4 4 4-4"/></svg> </button>
                        <div class="custom-dropdown-options" id="add-topic-modal-subject-options"> </div>
                        <input type="hidden" id="add-topic-modal-subject-value" value="Phy">
                    </div>
                </div>
                <div id="add-topic-daily-fields">
                     <label class="block text-sm font-medium text-slate-300 mb-1">Session</label>
                     <div class="custom-dropdown" data-target-input="add-topic-modal-session-value">
                        <button type="button" class="custom-dropdown-button"> <span class="selected-value">Morning Session</span> <svg class="arrow w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 8l4 4 4-4"/></svg> </button>
                        <div class="custom-dropdown-options" id="add-topic-modal-session-options"> </div>
                        <input type="hidden" id="add-topic-modal-session-value" value="Morning Session">
                     </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1">Study Type</label>
                    <div class="custom-dropdown" data-target-input="add-topic-modal-study-value">
                        <button type="button" class="custom-dropdown-button"> <span class="selected-value">MQB</span> <svg class="arrow w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 8l4 4 4-4"/></svg> </button>
                        <div class="custom-dropdown-options"> <div class="custom-dropdown-option selected" data-value="mqb">MQB</div> <div class="custom-dropdown-option" data-value="ret">Retina QB</div> <div class="custom-dropdown-option" data-value="med">Meditrics</div> <div class="custom-dropdown-option" data-value="camp">Campus Exam</div> <div class="custom-dropdown-option" data-value="week">Weekly Exam</div> <div class="custom-dropdown-option" data-value="rev">Revision Class</div> <div class="custom-dropdown-option" data-value="new">1st Time Reading</div> </div>
                        <input type="hidden" id="add-topic-modal-study-value" value="mqb">
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-8"> <button id="add-topic-modal-cancel" class="modern-button button-secondary">Cancel</button> <button id="add-topic-modal-save" class="modern-button button-primary">Save Topic</button> </div>
        </div>
    </div>

    <div id="edit-modal" class="modal-backdrop" style="z-index: 50;">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-5 text-white">Edit Topic</h3>
            <div class="mb-4">
                <label for="modal-topic-name" class="block text-sm font-medium text-slate-300 mb-1">Topic Name</label>
                <input type="text" id="modal-topic-name" class="w-full p-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
            </div>
            <div class="mb-4">
                <label for="modal-topic-note" class="block text-sm font-medium text-slate-300 mb-1">Notes</label>
                <textarea id="modal-topic-note" rows="4" class="w-full p-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-white" placeholder="Add your notes here..."></textarea>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-5">
                 <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1">Hardness</label>
                    <div class="custom-dropdown" data-target-input="modal-topic-hardness-value">
                        <button type="button" class="custom-dropdown-button"> <span class="selected-value">Medium</span> <svg class="arrow w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 8l4 4 4-4"/></svg> </button>
                        <div class="custom-dropdown-options"> <div class="custom-dropdown-option" data-value="easy">Easy</div> <div class="custom-dropdown-option" data-value="medium">Medium</div> <div class="custom-dropdown-option" data-value="hard">Hard</div> </div>
                        <input type="hidden" id="modal-topic-hardness-value" value="medium">
                    </div>
                </div>
                <div>
                     <label class="block text-sm font-medium text-slate-300 mb-1">Study Type</label>
                     <div class="custom-dropdown" data-target-input="modal-topic-study-value">
                         <button type="button" class="custom-dropdown-button"> <span class="selected-value">MQB</span> <svg class="arrow w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 8l4 4 4-4"/></svg> </button>
                         <div class="custom-dropdown-options"> <div class="custom-dropdown-option" data-value="mqb">MQB</div> <div class="custom-dropdown-option" data-value="ret">Retina QB</div> <div class="custom-dropdown-option" data-value="med">Meditrics</div> <div class="custom-dropdown-option" data-value="camp">Campus Exam</div> <div class="custom-dropdown-option" data-value="week">Weekly Exam</div> <div class="custom-dropdown-option" data-value="rev">Revision Class</div> <div class="custom-dropdown-option" data-value="new">1st Time Reading</div> </div>
                         <input type="hidden" id="modal-topic-study-value" value="mqb">
                     </div>
                </div>
            </div>
            <div class="mb-6">
                <label class="block text-sm font-medium text-slate-300 mb-2">Priority</label>
                <div id="modal-priority-selector" class="flex flex-wrap gap-2">
                    <button type="button" data-priority="high" class="priority-btn group"><span class="priority-indicator priority-high"></span> High</button>
                    <button type="button" data-priority="medium" class="priority-btn group"><span class="priority-indicator priority-medium"></span> Medium</button>
                    <button type="button" data-priority="low" class="priority-btn group"><span class="priority-indicator priority-low"></span> Low</button>
                </div>
            </div>
            <div class="flex justify-between items-center flex-wrap gap-4 mt-8"> <button id="modal-delete" class="modern-button button-danger">Delete Topic</button> <div class="flex gap-3"> <button id="modal-cancel" class="modern-button button-secondary">Cancel</button> <button id="modal-save" class="modern-button button-success">Save Changes</button> </div> </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-2 text-white">Are you sure?</h3>
            <p id="confirm-message" class="text-slate-300 mb-6">Action cannot be undone.</p>
            <div class="flex justify-end gap-3"> <button id="confirm-cancel" class="modern-button button-secondary">Cancel</button> <button id="confirm-yes" class="modern-button button-danger">Yes, Delete</button> </div>
        </div>
    </div>

    <div id="calendar-modal" class="modal-backdrop" style="z-index: 55;">
        <div class="modal-content">
            <div id="calendar-header"> <button type="button" id="calendar-prev-month"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="text-slate-400" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/></svg></button> <div id="calendar-month-year" class="text-white">Month Year</div> <button type="button" id="calendar-next-month"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="text-slate-400" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg></button> </div>
            <div id="calendar-weekdays" class="text-slate-400"><div>Su</div><div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div></div>
            <div id="calendar-days"></div>
            <button id="calendar-cancel" class="w-full modern-button button-secondary mt-4">Cancel</button>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // App State
        let db, auth, dbDocRef, unsubscribeSnapshot; let countdownInterval, saveTimeout, toastTimeout; let isFirstLoad=true; let pendingChanges=false; let currentView='table1'; let confirmCallback=null; let calendarState={ month:9, year:2025 }; const toastQueue=[]; let isToastShowing=false; const appData={ completedTopics:{} };
        const DEFAULT_TABLE_DATA={ table1:{"28/10/2025":{Phy:["Motion","Work","Gas"],Chem:["Organic (2.0-2.11.2)"],Bio:["Tissue","Bryophyta","JiboProjukti"],GK:[],English:["Spelling","Syn-Ant + Translation","Appropriate Prep"]},"31/10/2025":{Phy:["Voutojogot","Gravity","Jamitik","Semiconductor","Stir Torith","Cholotorith"],Chem:["Chemical Change","Porimangoto","Poribesh","Orthonoitik"],Bio:["Somonnoy full","Soshon","nognobiji"],GK:[],English:[]},"02/11/2025":{Phy:["Optics","Modern","Neuclear"],Chem:["Organic 2.1.3--last"],Bio:["Colon","Dharabahikota"],GK:[],English:["Group Verb","Proverb","Idioms and Phrases"]}}, table2:{"26/10/2025":{"Morning Session":["Tissue","Bryophyta","JiboProjukti"],"Noon Session":["গতিবিদ্যা"],"Night Session":["Organic (C+Meditrics)"],"Secret Files":["Tissue","Bryophta","JiboProjukti","Gotibidda"]},"27/10/2025":{"Morning Session":["Gas","Work Revision","Secret Files"],"Noon Session":["Organic All Left Classes"],"Night Session":["Spelling (All)"],"Secret Files":[]},"28/10/2025":{"Morning Session":["Organic for Weekly."],"Noon Session":["Weekly Session"],"Night Session":["Gravity","Cholotorith"],"Secret Files":["Gravity","Cholotorith"]},"29/10/2025":{"Morning Session":["পরিমাণগত রসায়ন","পরিবেশ রসায়ন"],"Noon Session":["অর্থনৈতিক রসায়ন – Class+Book"],"Night Session":["অর্থনৈতিক রসায়ন-MQB"],"Secret Files":["অর্থনৈতিক রসায়ন","পরিমাণগত রসায়ন","পরিবেশ রসায়ন"]},"30/10/2025":{"Morning Session":["Somonnoy full"],"Noon Session":[],"Night Session":["Somonnoy MQB","Monthly English"],"Secret Files":["Somonnoy, left exams"]},"31/10/2025":{"Morning Session":["revision"],"Noon Session":["exam"],"Night Session":["Neuclear---mqb","Modern"],"Secret Files":["Neuclear Phy","Modern"]},"01/11/2025":{"Morning Session":["Colon"],"Noon Session":["Dharabahikota"],"Night Session":["Mixed"],"Secret Files":["Colon","dharabahikota"]},"02/11/2025":{"Morning Session":["Optics(Class)"],"Noon Session":["+MQB"],"Night Session":["Exam","Remake rutine"],"Secret Files":[]}} };
        let tableData={ table1:{}, table2:{} };
        const columnHeaders={ table1:["Phy","Chem","Bio","GK","English"], table2:["Morning Session","Noon Session","Night Session","Secret Files"] };
        const progressSteps=[0,20,40,60,80,100]; const today=new Date(2025,9,28);
        const studyStatusMap={mqb:"MQB",ret:"RET",med:"MED",camp:"CAMP",week:"WEEK",rev:"REV",new:"NEW"};
        const studyStatusFullNames={mqb:"MQB",ret:"Retina QB",med:"Meditrics",camp:"Campus Exam",week:"Weekly Exam",rev:"Revision Class",new:"1st Time Reading"};

        // DOM Elements
        const loadingEl=document.getElementById('loading'), contentEl=document.getElementById('content'), modalEl=document.getElementById('edit-modal'), modalTopicName=document.getElementById('modal-topic-name'), modalTopicNote=document.getElementById('modal-topic-note'), addTopicModalEl=document.getElementById('add-topic-modal'), addTopicModalName=document.getElementById('add-topic-modal-name'), table1Section=document.getElementById('table1-section'), table2Section=document.getElementById('table2-section'), table1CardsContainer=document.getElementById('table1-cards'), table2CardsContainer=document.getElementById('table2-cards'), viewToggleBtnTable1=document.getElementById('view-toggle-table1'), viewToggleBtnTable2=document.getElementById('view-toggle-table2'), addRowBtnTable1=document.getElementById('add-row-t1'), addRowBtnTable2=document.getElementById('add-row-t2'), confirmModalEl=document.getElementById('confirm-modal'), confirmMessageEl=document.getElementById('confirm-message'), calendarModalEl=document.getElementById('calendar-modal'), calendarDaysEl=document.getElementById('calendar-days'), calendarMonthYearEl=document.getElementById('calendar-month-year');
        const addHardnessInput=document.getElementById('add-topic-modal-hardness-value'), addSubjectInput=document.getElementById('add-topic-modal-subject-value'), addSessionInput=document.getElementById('add-topic-modal-session-value'), addStudyInput=document.getElementById('add-topic-modal-study-value'), editHardnessInput=document.getElementById('modal-topic-hardness-value'), editStudyInput=document.getElementById('modal-topic-study-value');

        // Initialization
        document.addEventListener('DOMContentLoaded', ()=>{ calendarState={ month:today.getMonth(), year:today.getFullYear() }; const savedView=localStorage.getItem('lastFightTrackerView'); if(savedView==='table2')currentView='table2'; updateViewToggleUI(); populateAddTopicDropdowns(); initializeAppFirebase(); startCountdown(); setupGlobalEventListeners(); });

        // Populate Static Dropdowns
        function populateAddTopicDropdowns(){ const subjectOptionsContainer=document.getElementById('add-topic-modal-subject-options'); subjectOptionsContainer.innerHTML=''; columnHeaders.table1.forEach((subject,index)=>{const option=document.createElement('div');option.className='custom-dropdown-option';if(index===0)option.classList.add('selected');option.dataset.value=subject;option.textContent=subject;subjectOptionsContainer.appendChild(option);}); if(columnHeaders.table1.length>0)addSubjectInput.value=columnHeaders.table1[0]; const sessionOptionsContainer=document.getElementById('add-topic-modal-session-options'); sessionOptionsContainer.innerHTML=''; columnHeaders.table2.forEach((session,index)=>{const option=document.createElement('div');option.className='custom-dropdown-option';if(index===0)option.classList.add('selected');option.dataset.value=session;option.textContent=session;sessionOptionsContainer.appendChild(option);}); if(columnHeaders.table2.length>0)addSessionInput.value=columnHeaders.table2[0]; initDropdownDisplay(addTopicModalEl); }

        // Firebase Initialization
        async function initializeAppFirebase(){ try{const appId=typeof __app_id!=='undefined'?__app_id:'default-app-id';let firebaseConfig;if(typeof __firebase_config!=='undefined'){try{firebaseConfig=JSON.parse(__firebase_config);}catch(e){firebaseConfig=null;console.warn("Could not parse __firebase_config");}}if(!firebaseConfig||!firebaseConfig.apiKey){firebaseConfig={apiKey:"AIzaSyDTLhIkrW9qk6KPT_gTDibIiJeVwWYTowk",authDomain:"my-study-dashboard.firebaseapp.com",databaseURL:"https://my-study-dashboard-default-rtdb.firebaseio.com",projectId:"my-study-dashboard",storageBucket:"my-study-dashboard.firebasestorage.app",messagingSenderId:"66307909031",appId:"1:66307909031:web:a077b8cf1a046069f80282"};}const initialAuthToken=typeof __initial_auth_token!=='undefined'?__initial_auth_token:null;const app=initializeApp(firebaseConfig);db=getFirestore(app);auth=getAuth(app);try{await enableIndexedDbPersistence(db);}catch(err){console.warn("Offline persistence failed:",err.code);}await authenticateUser(initialAuthToken,appId);}catch(error){console.error("Firebase Init Error:",error);loadingEl.innerHTML=`<p class="text-red-400">Error: Init failed.</p>`;}}
        async function authenticateUser(token,appId){try{if(token){await signInWithCustomToken(auth,token);}else{await signInAnonymously(auth);}const userId=auth.currentUser.uid;const docPath=`artifacts/${appId}/users/${userId}/studyProgress/data`;dbDocRef=doc(db,docPath);loadDataFromFirestore();}catch(error){console.error("Auth Error:",error);loadingEl.innerHTML=`<p class="text-red-400">Error: Auth failed.</p>`;}}
        function loadDataFromFirestore(){if(!dbDocRef)return;showToastQueued('syncing');if(unsubscribeSnapshot)unsubscribeSnapshot();unsubscribeSnapshot=onSnapshot(dbDocRef,(doc)=>{if(doc.exists()){const data=doc.data();appData.completedTopics=data.completedTopics||{};if(data.tableData){tableData=JSON.parse(JSON.stringify(data.tableData));if(!tableData.table1)tableData.table1={};if(!tableData.table2)tableData.table2={};}else{tableData=JSON.parse(JSON.stringify(DEFAULT_TABLE_DATA));setTimeout(()=>{saveDataToFirestore();},100);}}else{tableData=JSON.parse(JSON.stringify(DEFAULT_TABLE_DATA));setTimeout(()=>{saveDataToFirestore();},100);}renderData();showToastQueued(doc.metadata.fromCache?"cached":"synced");},(error)=>{console.error("Firestore snapshot error:",error);loadingEl.innerHTML=`<p class="text-red-400">Error: Load failed.</p>`;showToastQueued('error');});}

        // Data Rendering
        function renderData(){ renderAllCards(); updateAllProgressUI(); updateViewToggleUI(); loadingEl.classList.remove('show'); loadingEl.classList.add('hidden'); contentEl.classList.remove('hidden'); isFirstLoad=false; }
        function renderAllCards(){ table1CardsContainer.innerHTML=''; table2CardsContainer.innerHTML=''; if(!tableData.table1)tableData.table1={}; if(!tableData.table2)tableData.table2={}; Object.keys(tableData).forEach(tableId=>{ const container=tableId==='table1'?table1CardsContainer:table2CardsContainer; const data=tableData[tableId]; if(!container||!data)return; const dates=Object.keys(data).sort((a,b)=>{try{const dateA=new Date(a.split('/').reverse().join('-'));const dateB=new Date(b.split('/').reverse().join('-'));return dateA - dateB;}catch(e){return 0;}}); dates.forEach(date=>{ const cardData=data[date]||{}; const card=createDateCard(tableId,date,cardData); container.appendChild(card); }); }); updateExistingTopics(); updateAllCardProgressBars(); }
        function createDateCard(tableId, date, dateData){ const card=document.createElement('div'); card.className='date-card'; card.dataset.tableId=tableId; card.dataset.date=date; const cardHeader=document.createElement('div'); cardHeader.className='date-header'; const dateDiv=document.createElement('div'); dateDiv.className='date-header-text'; dateDiv.textContent=date; dateDiv.contentEditable="true"; dateDiv.dataset.originalDate=date; dateDiv.dataset.label="Date"; dateDiv.setAttribute('placeholder','DD/MM/YYYY'); cardHeader.appendChild(dateDiv); const dateId=date.replace(/\//g,'-'); const progressContainer=document.createElement('div'); progressContainer.className='card-progress-container'; progressContainer.innerHTML=`<div class="card-progress-text" id="card-progress-text-${tableId}-${dateId}">0%</div><div class="card-progress-bar-bg"><div class="card-progress-bar-fg" id="card-progress-bar-${tableId}-${dateId}" style="width:0%;"></div></div><div class="card-progress-count" id="card-progress-count-${tableId}-${dateId}">0 / 0 Done</div>`; cardHeader.appendChild(progressContainer); cardHeader.appendChild(createDeleteRowButton(card)); card.appendChild(cardHeader); const headers=columnHeaders[tableId]; headers.forEach(colName=>{ const topics=dateData[colName]; if(date==="New Date"||(Array.isArray(topics)&&topics.length>0)){ const section=document.createElement('div'); section.className='column-section'; section.dataset.colName=colName; section.innerHTML=`<span class="column-title">${colName}</span>`; if(Array.isArray(topics)){ topics.forEach(topicName=>{ if(typeof topicName==='string'){ const topicId=createTopicId(tableId,date,colName,topicName,true); const topicEl=createTopicElement(topicId,topicName); section.appendChild(topicEl); } }); } card.appendChild(section); } }); const cardFooter=document.createElement('div'); cardFooter.className='card-footer'; const addBtn=document.createElement('button'); addBtn.type='button'; addBtn.className='add-topic-btn-card-single'; addBtn.textContent='+ Add New Topic'; cardFooter.appendChild(addBtn); card.appendChild(cardFooter); return card; }
        function updateExistingTopics(){ document.querySelectorAll('.progress-box').forEach(box=>{ const topicId=box.dataset.topicId;const topicData=appData.completedTopics[topicId];const parentItem=box.closest('.topic-item');if(!parentItem)return; if(topicData){ const progress=topicData.progress||0;box.className=`progress-box progress-${progress}`;box.innerHTML=`<span>${progress}%</span>`; const nameEl=parentItem.querySelector('.topic-name');if(nameEl&&topicData.name&&nameEl.firstChild){const nameTextNode=nameEl.querySelector('.topic-name-text');if(nameTextNode)nameTextNode.textContent=topicData.name+' ';} const iconEl=parentItem.querySelector('.edit-icon');if(iconEl){iconEl.classList.toggle('has-note',!!topicData.note);iconEl.title=topicData.note||'Add/Edit Note...';} const indicatorEl=parentItem.querySelector('.priority-indicator');const priority=topicData.priority||'low';if(indicatorEl){indicatorEl.className=`priority-indicator priority-${priority}`;indicatorEl.title=`Priority: ${priority.charAt(0).toUpperCase()+priority.slice(1)}`;} const statusEl=parentItem.querySelector('.study-status');const studyStatus=topicData.studyStatus||'new';if(statusEl){statusEl.className=`study-status study-${studyStatus}`;statusEl.textContent=studyStatusMap[studyStatus]||'NEW';} }else{ box.className=`progress-box progress-0`;box.innerHTML=`<span>0%</span>`;const iconEl=parentItem.querySelector('.edit-icon');if(iconEl){iconEl.classList.remove('has-note');iconEl.title='Add/Edit Note...';}const indicatorEl=parentItem.querySelector('.priority-indicator');if(indicatorEl){indicatorEl.className=`priority-indicator priority-low`;indicatorEl.title=`Priority: Low`;}const statusEl=parentItem.querySelector('.study-status');if(statusEl){statusEl.className=`study-status study-new`;statusEl.textContent='NEW';} } }); }
        function createTopicElement(topicId,topicName){ const topicData=appData.completedTopics[topicId]||{};const progress=topicData.progress||0;const note=topicData.note||'';const displayName=topicData.name||topicName;const priority=topicData.priority||'low';const studyStatus=topicData.studyStatus||'new'; const topicEl=document.createElement('div');topicEl.className='topic-item';topicEl.draggable=true; const priorityIndicator=document.createElement('span');priorityIndicator.className=`priority-indicator priority-${priority}`;priorityIndicator.title=`Priority: ${priority.charAt(0).toUpperCase()+priority.slice(1)}`;topicEl.appendChild(priorityIndicator); const progressBox=document.createElement('div');progressBox.className=`progress-box progress-${progress}`;progressBox.innerHTML=`<span>${progress}%</span>`;progressBox.dataset.topicId=topicId; const nameEl=document.createElement('span');nameEl.className='topic-name';nameEl.dataset.topicName=displayName; const nameText=document.createElement('span');nameText.className='topic-name-text';nameText.textContent=displayName+' ';nameEl.appendChild(nameText); const statusTag=document.createElement('span');statusTag.className=`study-status study-${studyStatus}`;statusTag.textContent=studyStatusMap[studyStatus]||'NEW';nameEl.appendChild(statusTag); const editIcon=document.createElement('button');editIcon.type='button'; editIcon.className='edit-icon';if(note)editIcon.classList.add('has-note');editIcon.dataset.topicId=topicId;editIcon.title=note||'Add/Edit Note...';editIcon.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`; topicEl.appendChild(progressBox);topicEl.appendChild(nameEl);topicEl.appendChild(editIcon); return topicEl; }
        function createDeleteRowButton(cardElement){ const deleteBtn=document.createElement('button');deleteBtn.type='button';deleteBtn.className='delete-row-btn';deleteBtn.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;deleteBtn.title='Delete Date Card';return deleteBtn;}
        function createTopicId(tableId,date,colName,topicName,findExisting=false){ if(typeof topicName!=='string'){console.error(`Invalid topicName type:${topicName}`);topicName='invalid-topic';}const t=tableId.replace('table','t');const d=date.replace(/\//g,'-');const c=colName.toLowerCase().replace(/[^a-z0-9]/g,'');const n=topicName.toLowerCase().replace(/\s+/g,'-').replace(/[^\w\-]/g,'').substring(0,40);const baseId=`${t}_${d}_${c}_${n}`;if(findExisting){for(const topicId in appData.completedTopics){if(topicId.startsWith(baseId)&&appData.completedTopics[topicId].name===topicName){return topicId;}}}const time=Date.now().toString(36).slice(-4);const random=Math.random().toString(36).slice(-3);return `${baseId}_${time}${random}`; }
        function showConfirmationModal(message,onConfirm){confirmMessageEl.textContent=message;confirmCallback=onConfirm;openModal(confirmModalEl);}

        // Event Handlers
        function setupGlobalEventListeners(){ const container=document.body; container.addEventListener('click',(e)=>{ const target=e.target;const closestTarget=(selector)=>target.closest(selector); if(!closestTarget('.custom-dropdown')){closeAllDropdowns();} const dropdownButton=closestTarget('.custom-dropdown-button');if(dropdownButton){toggleDropdown(dropdownButton.closest('.custom-dropdown'));return;} const dropdownOption=closestTarget('.custom-dropdown-option');if(dropdownOption){selectDropdownOption(dropdownOption);return;} if(target.id==='view-toggle-table1'||target.id==='view-toggle-table2'){handleViewToggle(target.dataset.view);return;} const progressBox=closestTarget('.progress-box');if(progressBox){handleProgressClick(progressBox,false);return;} if(closestTarget('.edit-icon')){handleEditClick(closestTarget('.edit-icon'));return;} if(target.classList.contains('add-topic-btn-card-single')){handleAddTopicClick(target);return;} if(target.id==='add-row-t1'){addNewRow('table1');return;} if(target.id==='add-row-t2'){addNewRow('table2');return;} if(target.id==='open-calendar-btn'){handleOpenCalendar();return;} if(closestTarget('.delete-row-btn')){handleDeleteRowClick(closestTarget('.delete-row-btn'));return;} if(target.id==='modal-save'){handleModalSave();return;} if(target.id==='modal-cancel'||(closestTarget('#edit-modal')&&target===modalEl)){closeModal(modalEl);return;} if(target.id==='modal-delete'){handleModalDelete();return;} if(closestTarget('.priority-btn')){const btn=closestTarget('.priority-btn');document.querySelectorAll('#modal-priority-selector .priority-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');return;} if(target.id==='add-topic-modal-save'){handleModalAddSave();return;} if(target.id==='add-topic-modal-cancel'||(closestTarget('#add-topic-modal')&&target===addTopicModalEl)){closeModal(addTopicModalEl);return;} if(target.id==='confirm-yes'){if(typeof confirmCallback==='function'){confirmCallback();}confirmCallback=null;closeModal(confirmModalEl);return;} if(target.id==='confirm-cancel'||target===confirmModalEl){confirmCallback=null;closeModal(confirmModalEl);return;} if(target.id==='calendar-prev-month'||closestTarget('#calendar-prev-month')){const newMonth=calendarState.month-1;const newYear=newMonth<0?calendarState.year-1:calendarState.year;const newMonthNormalized=newMonth<0?11:newMonth;if(newYear<today.getFullYear()||(newYear===today.getFullYear()&&newMonthNormalized<today.getMonth())){showToastQueued('error','Cannot view past months');return;}calendarState.month=newMonthNormalized;calendarState.year=newYear;renderCalendar(calendarState.month,calendarState.year);return;} if(target.id==='calendar-next-month'||closestTarget('#calendar-next-month')){calendarState.month++;if(calendarState.month>11){calendarState.month=0;calendarState.year++;}renderCalendar(calendarState.month,calendarState.year);return;} if(closestTarget('.calendar-day')&&!target.closest('.calendar-day').classList.contains('empty')&&!target.closest('.calendar-day').classList.contains('disabled')){handleCalendarDateClick(closestTarget('.calendar-day'));return;} if(target.id==='calendar-cancel'||target===calendarModalEl){closeModal(calendarModalEl);return;} }); container.addEventListener('contextmenu',(e)=>{if(e.target.closest('.progress-box')){e.preventDefault();handleProgressClick(e.target.closest('.progress-box'),true);}}); container.addEventListener('focusin',(e)=>{const target=e.target;if(target.contentEditable==='true'&&target.dataset.label==='Date'){target.dataset.originalDate=target.textContent.trim();}}); container.addEventListener('blur',(e)=>{const target=e.target;if(target.contentEditable==='true'&&target.dataset.label==='Date'){handleDateChange(target);}},true); let draggedElement=null;container.addEventListener('dragstart',(e)=>{if(e.target.classList.contains('topic-item')){draggedElement=e.target;setTimeout(()=>{e.target.classList.add('dragging');},0);}});container.addEventListener('dragend',(e)=>{if(draggedElement)draggedElement.classList.remove('dragging');draggedElement=null;document.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over'));});container.addEventListener('dragenter',(e)=>{const section=e.target.closest('.column-section');if(section&&draggedElement){document.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over'));section.classList.add('drag-over');}});container.addEventListener('drop',(e)=>{e.preventDefault();const section=e.target.closest('.column-section');document.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over'));if(section&&draggedElement)handleDragDrop(draggedElement,section);}); document.addEventListener('keydown',(e)=>{const target=e.target;if(target.tagName==='INPUT'||target.tagName==='TEXTAREA'||target.contentEditable==='true')return;if(target.contentEditable==='true'&&target.dataset.label==='Date'&&e.key==='Enter'){e.preventDefault();target.blur();return;}if(e.key==='n'&&!modalEl.classList.contains('show')&&!addTopicModalEl.classList.contains('show')&&!confirmModalEl.classList.contains('show')&&!calendarModalEl.classList.contains('show')){e.preventDefault();const currentCardsContainer=currentView==='table1'?table1CardsContainer:table2CardsContainer;const firstCard=currentCardsContainer.querySelector('.date-card');if(firstCard&&firstCard.dataset.date!=='New Date'){const addBtn=firstCard.querySelector('.add-topic-btn-card-single');if(addBtn)addBtn.click();}else if(firstCard){showToastQueued('error','Set date first.');}else{showToastQueued('error','Add card first.');}return;}if(modalEl.classList.contains('show')&&e.key==='Escape'){closeModal(modalEl);return;}if(addTopicModalEl.classList.contains('show')&&e.key==='Escape'){closeModal(addTopicModalEl);return;}if(confirmModalEl.classList.contains('show')&&e.key==='Escape'){confirmCallback=null;closeModal(confirmModalEl);return;}if(calendarModalEl.classList.contains('show')&&e.key==='Escape'){closeModal(calendarModalEl);return;}if(addTopicModalEl.classList.contains('show')&&e.key==='Enter'){e.preventDefault();handleModalAddSave();return;}}); window.addEventListener('beforeunload',window.cleanupAppListeners); }

        // Custom Dropdown Functions
        function toggleDropdown(dropdownElement){const button=dropdownElement.querySelector('.custom-dropdown-button');const options=dropdownElement.querySelector('.custom-dropdown-options');const isOpen=options.classList.contains('show');closeAllDropdowns();if(!isOpen){options.classList.add('show');button.classList.add('active');}}
        function closeAllDropdowns(){document.querySelectorAll('.custom-dropdown-options.show').forEach(options=>{options.classList.remove('show');options.closest('.custom-dropdown').querySelector('.custom-dropdown-button').classList.remove('active');});}
        function selectDropdownOption(optionElement){const dropdownElement=optionElement.closest('.custom-dropdown');const button=dropdownElement.querySelector('.custom-dropdown-button');const selectedValueSpan=button.querySelector('.selected-value');const hiddenInput=document.getElementById(dropdownElement.dataset.targetInput);const value=optionElement.dataset.value;const text=optionElement.textContent;selectedValueSpan.textContent=text;hiddenInput.value=value;dropdownElement.querySelectorAll('.custom-dropdown-option').forEach(opt=>opt.classList.remove('selected'));optionElement.classList.add('selected');closeAllDropdowns();}
        function setDropdownValue(dropdownElement,newValue){const hiddenInput=document.getElementById(dropdownElement.dataset.targetInput);const options=dropdownElement.querySelectorAll('.custom-dropdown-option');const buttonText=dropdownElement.querySelector('.selected-value');let found=false;options.forEach(option=>{option.classList.remove('selected');if(option.dataset.value===newValue){option.classList.add('selected');buttonText.textContent=option.textContent;hiddenInput.value=newValue;found=true;}});if(!found&&options.length>0){options[0].classList.add('selected');buttonText.textContent=options[0].textContent;hiddenInput.value=options[0].dataset.value;}else if(!found){buttonText.textContent='Select...';hiddenInput.value='';}}
        function initDropdownDisplay(modalContainer){modalContainer.querySelectorAll('.custom-dropdown').forEach(dropdown=>{const selectedOption=dropdown.querySelector('.custom-dropdown-option.selected');const buttonText=dropdown.querySelector('.selected-value');if(selectedOption){buttonText.textContent=selectedOption.textContent;}else if(dropdown.querySelectorAll('.custom-dropdown-option').length>0){const firstOption=dropdown.querySelector('.custom-dropdown-option');firstOption.classList.add('selected');buttonText.textContent=firstOption.textContent;document.getElementById(dropdown.dataset.targetInput).value=firstOption.dataset.value;}});}
        function openModal(modalElement){modalElement.classList.add('show');}
        function closeModal(modalElement){modalElement.classList.remove('show');}

        // Core Logic Functions
        function handleProgressClick(box,isReverse=false){const topicId=box.dataset.topicId;if(!topicId)return;const currentProgress=appData.completedTopics[topicId]?.progress||0;const currentIndex=progressSteps.indexOf(currentProgress);let nextIndex;if(isReverse){nextIndex=Math.max(0,currentIndex-1);}else{nextIndex=(currentIndex+1)%progressSteps.length;}const newProgress=progressSteps[nextIndex];document.querySelectorAll(`.progress-box[data-topic-id="${topicId}"]`).forEach(b=>{b.className=`progress-box progress-${newProgress}`;b.innerHTML=`<span>${newProgress}%</span>`;});if(!appData.completedTopics[topicId]){const nameEl=box.closest('.topic-item')?.querySelector('.topic-name');const nameTextNode=nameEl?nameEl.querySelector('.topic-name-text'):null;const nameText=nameTextNode?nameTextNode.textContent.trim():'Unknown';appData.completedTopics[topicId]={progress:newProgress,note:'',name:nameText,priority:'low',hardness:'medium',studyStatus:'new'};}else{appData.completedTopics[topicId].progress=newProgress;}saveDataToFirestore();updateAllProgressUI();}
        function handleEditClick(iconEl){ closeAllDropdowns(); closeModal(addTopicModalEl); const topicId=iconEl.dataset.topicId;if(!topicId){console.error("No topic ID");return;}const currentData=appData.completedTopics[topicId]||{};const nameEl=iconEl.closest('.topic-item')?.querySelector('.topic-name'); const nameTextNode=nameEl?nameEl.querySelector('.topic-name-text'):null; const defaultName=nameTextNode?nameTextNode.textContent.trim():(currentData.name||'');const currentName=currentData.name||defaultName;const currentNote=currentData.note||'';const currentPriority=currentData.priority||'low';const currentHardness=currentData.hardness||'medium';const currentStudy=currentData.studyStatus||'new';modalEl.dataset.currentTopicId=topicId;modalTopicName.value=currentName;modalTopicNote.value=currentNote; setDropdownValue(editHardnessInput.closest('.custom-dropdown'), currentHardness); setDropdownValue(editStudyInput.closest('.custom-dropdown'), currentStudy); document.querySelectorAll('#modal-priority-selector .priority-btn').forEach(btn=>{btn.classList.toggle('active',btn.dataset.priority===currentPriority);}); openModal(modalEl); modalTopicName.focus();}
        function handleAddTopicClick(button){ closeAllDropdowns(); closeModal(modalEl); const card=button.closest('.date-card');if(!card){console.error("No card context");return;}const tableId=card.dataset.tableId,date=card.dataset.date;if(date==='New Date'){showToastQueued('error','Set date first.');const dateDiv=card.querySelector('.date-header-text');if(dateDiv)dateDiv.focus();return;}addTopicModalEl.dataset.tableId=tableId;addTopicModalEl.dataset.date=date;const targetsFields=document.getElementById('add-topic-targets-fields');const dailyFields=document.getElementById('add-topic-daily-fields');if(tableId==='table1'){targetsFields.style.display='block';dailyFields.style.display='none';}else{targetsFields.style.display='none';dailyFields.style.display='block';}addTopicModalName.value=''; setDropdownValue(addHardnessInput.closest('.custom-dropdown'), 'medium'); setDropdownValue(addStudyInput.closest('.custom-dropdown'), 'mqb'); initDropdownDisplay(addTopicModalEl); openModal(addTopicModalEl); addTopicModalName.focus();}
        function handleModalAddSave(){const tableId=addTopicModalEl.dataset.tableId,date=addTopicModalEl.dataset.date;const newTopicName=addTopicModalName.value.trim();const hardness=addHardnessInput.value;const studyStatus=addStudyInput.value;let selectedColName=(tableId==='table1')?addSubjectInput.value:addSessionInput.value;if(!newTopicName){showToastQueued('error','Name empty.');return;}if(!tableId||!date||!selectedColName){console.error("Context missing");return;}const topicId=createTopicId(tableId,date,selectedColName,newTopicName);const card=document.querySelector(`.date-card[data-table-id="${tableId}"][data-date="${date}"]`);if(!card){console.error("No card");return;}let targetSection=card.querySelector(`.column-section[data-col-name="${selectedColName}"]`);if(!targetSection){targetSection=document.createElement('div');targetSection.className='column-section';targetSection.dataset.colName=selectedColName;targetSection.innerHTML=`<span class="column-title">${selectedColName}</span>`;const cardFooter=card.querySelector('.card-footer');if(cardFooter)card.insertBefore(targetSection,cardFooter);else card.appendChild(targetSection);}const existingNames=Array.from(targetSection.querySelectorAll('.topic-name-text')).map(el=>el.textContent.trim());if(existingNames.includes(newTopicName)){showToastQueued('error',`"${newTopicName}" exists.`);return;}if(!tableData[tableId][date])tableData[tableId][date]={};if(!tableData[tableId][date][selectedColName]||!Array.isArray(tableData[tableId][date][selectedColName]))tableData[tableId][date][selectedColName]=[];tableData[tableId][date][selectedColName].push(newTopicName);const topicEl=createTopicElement(topicId,newTopicName);targetSection.appendChild(topicEl);appData.completedTopics[topicId]={progress:0,note:'',name:newTopicName,priority:'low',hardness:hardness,studyStatus:studyStatus};saveDataToFirestore();updateAllProgressUI();closeModal(addTopicModalEl);}
        function handleModalSave(){const topicId=modalEl.dataset.currentTopicId;if(!topicId)return;const newName=modalTopicName.value.trim(),newNote=modalTopicNote.value.trim();if(newName===''){showToastQueued('error','Name empty.');return;}const selectedPriorityBtn=document.querySelector('#modal-priority-selector .priority-btn.active');const newPriority=selectedPriorityBtn?selectedPriorityBtn.dataset.priority:'low';const newHardness=editHardnessInput.value,newStudyStatus=editStudyInput.value;const currentData=appData.completedTopics[topicId]||{progress:0};const itemElement=document.querySelector(`.topic-item [data-topic-id="${topicId}"]`)?.closest('.topic-item');if(itemElement){const nameEl=itemElement.querySelector('.topic-name'); const nameTextNode=nameEl?nameEl.querySelector('.topic-name-text'):null; const oldName=nameTextNode?nameTextNode.textContent.trim():'';if(oldName!==newName){const section=itemElement.closest('.column-section'),card=itemElement.closest('.date-card');if(section&&card){const date=card.dataset.date,tableId=card.dataset.tableId,colName=section.dataset.colName;if(tableData[tableId]?.[date]?.[colName]){const topics=tableData[tableId][date][colName];const index=topics.indexOf(oldName);if(index>-1)topics[index]=newName;else{const appDataName=appData.completedTopics[topicId]?.name;if(appDataName){const appDataIndex=topics.indexOf(appDataName);if(appDataIndex>-1)topics[appDataIndex]=newName;}else console.warn(`Old name "${oldName}" not found.`);}}}}}else console.warn(`DOM element not found for ${topicId}`);appData.completedTopics[topicId]={...currentData,name:newName,note:newNote,priority:newPriority,hardness:newHardness,studyStatus:newStudyStatus};document.querySelectorAll(`[data-topic-id="${topicId}"]`).forEach(el=>{const parentItem=el.closest('.topic-item');if(!parentItem)return;const nameDisplay=parentItem.querySelector('.topic-name-text');if(nameDisplay)nameDisplay.textContent=newName+' ';const iconEl=parentItem.querySelector('.edit-icon');if(iconEl){iconEl.classList.toggle('has-note',!!newNote);iconEl.title=newNote||'Add/Edit Note...';}const indicator=parentItem.querySelector('.priority-indicator');if(indicator){indicator.className=`priority-indicator priority-${newPriority}`;indicator.title=`Priority: ${newPriority.charAt(0).toUpperCase()+newPriority.slice(1)}`;}const statusTag=parentItem.querySelector('.study-status');if(statusTag){statusTag.className=`study-status study-${newStudyStatus}`;statusTag.textContent=studyStatusMap[newStudyStatus]||'NEW';}});saveDataToFirestore();closeModal(modalEl);}
        function handleModalDelete(){const topicId=modalEl.dataset.currentTopicId;if(!topicId)return;showConfirmationModal("Delete this topic?",()=>{const itemElement=document.querySelector(`.topic-item [data-topic-id="${topicId}"]`)?.closest('.topic-item');let section=null,cardWasRemoved=false;if(itemElement){section=itemElement.closest('.column-section');const card=itemElement.closest('.date-card');if(section&&card){const date=card.dataset.date,tableId=card.dataset.tableId,colName=section.dataset.colName;const actualTopicName=appData.completedTopics[topicId]?.name;if(tableData[tableId]?.[date]?.[colName]&&actualTopicName){const topics=tableData[tableId][date][colName];const index=topics.indexOf(actualTopicName);if(index>-1){topics.splice(index,1);if(topics.length===0){delete tableData[tableId][date][colName];section.remove();}if(Object.keys(tableData[tableId][date]).length===0){delete tableData[tableId][date];card.remove();cardWasRemoved=true;}}else console.warn("Topic not found:",actualTopicName);}}}if(!cardWasRemoved){if(itemElement)itemElement.remove();if(section&&section.querySelectorAll('.topic-item').length===0)section.remove();}delete appData.completedTopics[topicId];saveDataToFirestore();updateAllProgressUI();closeModal(modalEl);});}
        function addNewRow(tableId,dateString="New Date"){const container=tableId==='table1'?table1CardsContainer:table2CardsContainer;if(!container)return;if(dateString!=="New Date"){const dateRegexStrict=/^\d{2}\/\d{2}\/\d{4}$/;if(!dateRegexStrict.test(dateString)){showToastQueued('error','Invalid date format.');return;}}if(tableData[tableId]&&tableData[tableId][dateString]){showToastQueued('error',`Card ${dateString} exists.`);const existingCard=container.querySelector(`.date-card[data-date="${dateString}"]`);if(existingCard){existingCard.scrollIntoView({behavior:'smooth',block:'center'});existingCard.classList.add('animate-pulse');setTimeout(()=>existingCard.classList.remove('animate-pulse'),2000);}return;}if(dateString==="New Date"){const existingNewDateCard=container.querySelector('.date-card[data-date="New Date"]');if(existingNewDateCard){showToastQueued('error','Set date first.');const dateDiv=existingNewDateCard.querySelector('.date-header-text');if(dateDiv)dateDiv.focus();return;}}const newCardData={};columnHeaders[tableId].forEach(colName=>newCardData[colName]=[]);if(!tableData[tableId])tableData[tableId]={};tableData[tableId][dateString]=newCardData;const card=createDateCard(tableId,dateString,newCardData);container.appendChild(card);const cards=Array.from(container.children);cards.sort((a,b)=>{try{const dateAStr=a.dataset.date.split('/').reverse().join('-');const dateBStr=b.dataset.date.split('/').reverse().join('-');if(dateAStr==='New-Date')return 1;if(dateBStr==='New-Date')return -1;const dateA=new Date(dateAStr);const dateB=new Date(dateBStr);if(isNaN(dateA)&&!isNaN(dateB))return 1;if(!isNaN(dateA)&&isNaN(dateB))return -1;if(isNaN(dateA)&&isNaN(dateB))return 0;return dateA - dateB;}catch(e){return 0;}});cards.forEach(c=>container.appendChild(c));if(dateString==="New Date"){const dateDiv=card.querySelector('.date-header-text');if(dateDiv){dateDiv.focus();const range=document.createRange();range.selectNodeContents(dateDiv);const selection=window.getSelection();selection.removeAllRanges();selection.addRange(range);}}else{card.scrollIntoView({behavior:'smooth',block:'center'});}updateCardProgress(card);saveDataToFirestore();}
        function handleDeleteRowClick(button){const cardElement=button.closest('.date-card');if(!cardElement)return;showConfirmationModal("Delete this card?",()=>{const tableId=cardElement.dataset.tableId,date=cardElement.dataset.date;if(tableId&&date&&tableData[tableId]?.[date])delete tableData[tableId][date];cardElement.querySelectorAll('.progress-box').forEach(box=>delete appData.completedTopics[box.dataset.topicId]);cardElement.remove();saveDataToFirestore();updateAllProgressUI();});}
        function handleDateChange(dateDiv){const card=dateDiv.closest('.date-card');const newDateRaw=dateDiv.textContent.trim();const oldDateRaw=dateDiv.dataset.originalDate.trim();if(!card||!newDateRaw||newDateRaw===oldDateRaw||newDateRaw==='New Date'){if(newDateRaw!==oldDateRaw&&(newDateRaw===''||newDateRaw==='New Date')){dateDiv.textContent=oldDateRaw;}else if(!newDateRaw){dateDiv.textContent=oldDateRaw;}return;}const dateRegexStrict=/^\d{2}\/\d{2}\/\d{4}$/;if(!dateRegexStrict.test(newDateRaw)){showToastQueued('error','Use DD/MM/YYYY.');dateDiv.textContent=oldDateRaw;return;}const[day,month,year]=newDateRaw.split('/').map(Number);const testDate=new Date(year,month-1,day);if(isNaN(testDate.getTime())||testDate.getDate()!==day||testDate.getMonth()!==month-1||testDate.getFullYear()!==year){showToastQueued('error','Invalid date!');dateDiv.textContent=oldDateRaw;return;}const newDate=newDateRaw;const oldDate=oldDateRaw;const tableId=card.dataset.tableId,container=tableId==='table1'?table1CardsContainer:table2CardsContainer;const allDateDivs=container.querySelectorAll('.date-header-text');const existingDates=Array.from(allDateDivs).filter(div=>div!==dateDiv).map(div=>div.textContent.trim());if(existingDates.includes(newDate)){showToastQueued('error','Date exists!');dateDiv.textContent=oldDate;return;}dateDiv.dataset.originalDate=newDate;card.dataset.date=newDate;const oldDateId=oldDate.replace(/\//g,'-');const newDateId=newDate.replace(/\//g,'-');const bar=card.querySelector(`#card-progress-bar-${tableId}-${oldDateId}`);const text=card.querySelector(`#card-progress-text-${tableId}-${oldDateId}`);const count=card.querySelector(`#card-progress-count-${tableId}-${oldDateId}`);if(bar)bar.id=`card-progress-bar-${tableId}-${newDateId}`;if(text)text.id=`card-progress-text-${tableId}-${newDateId}`;if(count)count.id=`card-progress-count-${tableId}-${newDateId}`;if(oldDate==='New Date'){const existingData=tableData[tableId][oldDate]||{};tableData[tableId][newDate]=existingData;columnHeaders[tableId].forEach(colName=>{if(!tableData[tableId][newDate][colName])tableData[tableId][newDate][colName]=[];});if(tableData[tableId][oldDate])delete tableData[tableId][oldDate];}else if(tableData[tableId]?.[oldDate]){tableData[tableId][newDate]=tableData[tableId][oldDate];delete tableData[tableId][oldDate];}let idsChanged=false;card.querySelectorAll('.progress-box').forEach(box=>{const topicId=box.dataset.topicId;const oldData=appData.completedTopics[topicId];if(!oldData)return;const parts=topicId.split('_');if(parts.length<5){console.warn("Skipping ID update:",topicId);return;}const nameEl=box.closest('.topic-item')?.querySelector('.topic-name'); const nameTextNode=nameEl?nameEl.querySelector('.topic-name-text'):null; const topicName=nameTextNode?nameTextNode.textContent.trim():(oldData.name||'Unknown');const colName=parts.slice(2,parts.length-2).join('_'); const newTopicId=createTopicId(tableId,newDate,colName,topicName);if(newTopicId!==topicId){idsChanged=true;delete appData.completedTopics[topicId];appData.completedTopics[newTopicId]=oldData;box.dataset.topicId=newTopicId;const icon=box.closest('.topic-item')?.querySelector('.edit-icon');if(icon)icon.dataset.topicId=newTopicId;}});if(oldDate!==newDate||idsChanged){saveDataToFirestore();setTimeout(()=>{updateCardProgress(card);},50);}}
        function handleDragDrop(draggedElement,toSection){ const oldSection=draggedElement.closest('.column-section');const toCard=toSection.closest('.date-card');const oldCard=oldSection?oldSection.closest('.date-card'):null; if(!oldSection||!toSection||!toCard||!oldCard||oldSection===toSection){console.warn("Drag drop validation failed.");draggedElement.classList.remove('dragging');return;} const topicId=draggedElement.querySelector('[data-topic-id]')?.dataset.topicId;if(!topicId){console.error("Dragged item missing ID");return;} const currentTopicData=appData.completedTopics[topicId]; const topicName=currentTopicData?.name||draggedElement.querySelector('.topic-name')?.dataset.topicName||'Unknown Topic'; const newDate=toCard.dataset.date,newColName=toSection.dataset.colName,newTableId=toCard.dataset.tableId;const oldDate=oldCard.dataset.date,oldColName=oldSection.dataset.colName,oldTableId=oldCard.dataset.tableId; const oldTopicId=topicId;const oldData=appData.completedTopics[oldTopicId]; const newTopicId=createTopicId(newTableId,newDate,newColName,topicName); if(oldTopicId===newTopicId)return; const targetExistingNames=Array.from(toSection.querySelectorAll('.topic-name-text')).map(el=>el.textContent.trim());if(targetExistingNames.includes(topicName)){showToastQueued('error',`"${topicName}" exists here.`);return;} if(appData.completedTopics[newTopicId]){showToastQueued('error','ID conflict.');return;} if(tableData[oldTableId]?.[oldDate]?.[oldColName]){const topics=tableData[oldTableId][oldDate][oldColName];const index=topics.indexOf(topicName);if(index>-1){topics.splice(index,1);if(topics.length===0)delete tableData[oldTableId][oldDate][oldColName];if(Object.keys(tableData[oldTableId][oldDate]).length===0)delete tableData[oldTableId][oldDate];}else console.warn(`Topic "${topicName}" not found.`);} if(!tableData[newTableId])tableData[newTableId]={};if(!tableData[newTableId][newDate])tableData[newTableId][newDate]={};if(!tableData[newTableId][newDate][newColName])tableData[newTableId][newDate][newColName]=[];if(!tableData[newTableId][newDate][newColName].includes(topicName))tableData[newTableId][newDate][newColName].push(topicName); const fallbackStudyStatus=currentTopicData?.studyStatus||'new'; if(oldData){appData.completedTopics[newTopicId]=oldData;delete appData.completedTopics[oldTopicId];} else{appData.completedTopics[newTopicId]={progress:0,name:topicName,note:'',priority:'low',hardness:'medium',studyStatus:fallbackStudyStatus};} draggedElement.querySelectorAll('[data-topic-id]').forEach(el=>el.dataset.topicId=newTopicId);toSection.appendChild(draggedElement); setTimeout(()=>{ const currentOldSection=document.querySelector(`[data-col-name="${oldColName}"]`); const currentOldCard=oldCard?document.querySelector(`[data-date="${oldCard.dataset.date}"]`):null;if(currentOldSection&&currentOldSection.querySelectorAll('.topic-item').length===0)currentOldSection.remove();if(currentOldCard&&currentOldCard.querySelectorAll('.column-section').length===0)currentOldCard.remove();},50); saveDataToFirestore();updateAllProgressUI();}
        function handleViewToggle(viewId){if(currentView===viewId)return;currentView=viewId;localStorage.setItem('lastFightTrackerView',currentView);updateViewToggleUI();}
        function updateViewToggleUI(){if(currentView==='table1'){table1Section.classList.remove('hidden');addRowBtnTable1.classList.remove('hidden');table2Section.classList.add('hidden');viewToggleBtnTable1.classList.add('active');viewToggleBtnTable2.classList.remove('active');}else{table1Section.classList.add('hidden');addRowBtnTable1.classList.add('hidden');table2Section.classList.remove('hidden');viewToggleBtnTable1.classList.remove('active');viewToggleBtnTable2.classList.add('active');}}

        // Progress UI
        function updateAllProgressUI(){updateOverallProgress();updateTable2Progress();updateAllCardProgressBars();updateTaskCounters();}
        function updateOverallProgress(){const bar=document.getElementById('overall-progress-bar'),text=document.getElementById('overall-progress-text');if(!bar||!text)return;const container=table1CardsContainer;if(!container)return;const allBoxes=container.querySelectorAll('.progress-box'),totalBoxes=allBoxes.length;if(totalBoxes===0){bar.style.width='0%';text.textContent='0%';return;}let totalProgress=0;allBoxes.forEach(box=>totalProgress+=appData.completedTopics[box.dataset.topicId]?.progress||0);const overallAvg=totalBoxes>0?(totalProgress/(totalBoxes*100))*100:0;bar.style.width=`${overallAvg}%`;text.textContent=`${Math.round(overallAvg)}%`;}
        function updateTable2Progress(){const bar=document.getElementById('t2-overall-progress-bar'),text=document.getElementById('t2-overall-progress-text');if(!bar||!text)return;const container=table2CardsContainer;if(!container)return;const allBoxes=container.querySelectorAll('.progress-box'),totalBoxes=allBoxes.length;if(totalBoxes===0){bar.style.width='0%';text.textContent='0%';return;}let totalProgress=0;allBoxes.forEach(box=>totalProgress+=appData.completedTopics[box.dataset.topicId]?.progress||0);const overallAvg=totalBoxes>0?(totalProgress/(totalBoxes*100))*100:0;bar.style.width=`${overallAvg}%`;text.textContent=`${Math.round(overallAvg)}%`;}
        function updateTaskCounters(){['table1','table2'].forEach(tableId=>{const container=tableId==='table1'?table1CardsContainer:table2CardsContainer;const counterEl=document.getElementById(`${tableId.replace('table','t')}_task_counter`);if(!container||!counterEl)return;const allBoxes=container.querySelectorAll('.progress-box'),totalTasks=allBoxes.length;let completedTasks=0;allBoxes.forEach(box=>{if(appData.completedTopics[box.dataset.topicId]?.progress===100)completedTasks++;});counterEl.textContent=`${completedTasks}/${totalTasks} Done`;counterEl.classList.remove('opacity-0');});}
        function updateAllCardProgressBars(){document.querySelectorAll('.date-card').forEach(card=>updateCardProgress(card));}
        function updateCardProgress(cardElement){if(!cardElement)return;const tableId=cardElement.dataset.tableId,date=cardElement.dataset.date;if(!tableId||!date)return;const dateId=date.replace(/\//g,'-');const bar=document.getElementById(`card-progress-bar-${tableId}-${dateId}`);const text=document.getElementById(`card-progress-text-${tableId}-${dateId}`);const count=document.getElementById(`card-progress-count-${tableId}-${dateId}`);if(!bar||!text||!count){if(date!=="New Date")console.warn(`Progress elements missing for ${tableId}-${dateId}.`);return;}const allBoxes=cardElement.querySelectorAll('.progress-box'),totalTasks=allBoxes.length;let completedTasks=0;allBoxes.forEach(box=>{if(appData.completedTopics[box.dataset.topicId]?.progress===100)completedTasks++;});const percentage=(totalTasks>0)?(completedTasks/totalTasks)*100:0;bar.style.width=`${percentage}%`;text.textContent=`${Math.round(percentage)}%`;count.textContent=`${completedTasks}/${totalTasks} Done`;}

        // Calendar
        function handleOpenCalendar(){calendarState={month:today.getMonth(),year:today.getFullYear()};renderCalendar(calendarState.month,calendarState.year);openModal(calendarModalEl);}
        function renderCalendar(month,year){calendarDaysEl.innerHTML='';const monthNames=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];calendarMonthYearEl.textContent=`${monthNames[month]} ${year}`;const firstDayOfMonth=new Date(year,month,1).getDay();const daysInMonth=new Date(year,month+1,0).getDate();for(let i=0;i<firstDayOfMonth;i++)calendarDaysEl.innerHTML+=`<div class="calendar-day empty"></div>`;for(let day=1;day<=daysInMonth;day++){const dayEl=document.createElement('div');dayEl.className='calendar-day';dayEl.textContent=day;const dateStr=`${String(day).padStart(2,'0')}/${String(month+1).padStart(2,'0')}/${year}`;dayEl.dataset.date=dateStr;const currentDate=new Date(year,month,day);if(currentDate<new Date(today.getFullYear(),today.getMonth(),today.getDate())){dayEl.classList.add('disabled');dayEl.title="Cannot add past dates";}if(year===today.getFullYear()&&month===today.getMonth()&&day===today.getDate())dayEl.classList.add('today');if(tableData.table2&&tableData.table2[dateStr]){dayEl.classList.add('disabled');dayEl.title="Card exists";}calendarDaysEl.appendChild(dayEl);}}
        function handleCalendarDateClick(dayElement){ const dateString=dayElement.dataset.date;if(!dateString)return;if(tableData.table2&&tableData.table2[dateString]){showToastQueued('error',`Card for ${dateString} exists.`);return;} showConfirmationModal(`Add card for ${dateString}?`,()=>{ try { addNewRow('table2',dateString); closeModal(calendarModalEl); } catch (error) { console.error('Failed to add card:',error); showToastQueued('error','Failed to create card'); } }); }

        // Data Save & Toast
        function saveDataToFirestore(){ if(!dbDocRef)return;pendingChanges=true;if(saveTimeout)clearTimeout(saveTimeout);const currentTableData=JSON.parse(JSON.stringify(tableData));const currentTopics=JSON.parse(JSON.stringify(appData.completedTopics));const tableDataToSave=JSON.parse(JSON.stringify(currentTableData,(key,value)=>{if(Array.isArray(value))return value.filter(item=>typeof item==='string');return value===undefined?null:value;}));const topicsToSave={};for(const topicId in currentTopics){const topicData=currentTopics[topicId];if(topicData&&typeof topicData==='object'&&topicData.name!==undefined){topicsToSave[topicId]={progress:typeof topicData.progress==='number'?topicData.progress:0,name:typeof topicData.name==='string'?topicData.name:'Recovered',note:typeof topicData.note==='string'?topicData.note:'',priority:typeof topicData.priority==='string'?topicData.priority:'low',hardness:typeof topicData.hardness==='string'?topicData.hardness:'medium',studyStatus:typeof topicData.studyStatus==='string'?topicData.studyStatus:'new',};}else{console.warn(`Invalid topic data for ${topicId}`,topicData);}}saveTimeout=setTimeout(async()=>{if(!pendingChanges)return;pendingChanges=false;try{showToastQueued('syncing');await setDoc(dbDocRef,{completedTopics:topicsToSave,tableData:tableDataToSave},{merge:false});showToastQueued('synced');}catch(error){console.error("Firestore save error:",error);showToastQueued('error','Sync Error');pendingChanges=true;}},1000);}
        function showToastQueued(type,customMessage=''){toastQueue.push({type,customMessage});if(!isToastShowing)processToastQueue();}
        function processToastQueue(){if(toastQueue.length===0){isToastShowing=false;return;}isToastShowing=true;const{type,customMessage}=toastQueue.shift();const toast=document.getElementById('toast'),msg=document.getElementById('toast-message'),spinner=document.getElementById('toast-spinner');if(!toast||!msg||!spinner){isToastShowing=false;return;}clearTimeout(toastTimeout);let toastClass='';switch(type){case'syncing':toastClass='bg-blue-600 text-white';msg.textContent=customMessage||'Syncing...';spinner.style.display='block';break;case'synced':toastClass='bg-green-500 text-white';msg.textContent=customMessage||'Synced';spinner.style.display='none';break;case'cached':toastClass='bg-yellow-500 text-gray-900';msg.textContent=customMessage||'Offline';spinner.style.display='none';break;case'error':toastClass='bg-red-500 text-white';msg.textContent=customMessage||'Error';spinner.style.display='none';break;default:toastClass='bg-slate-700 text-white';msg.textContent=customMessage||'Info';spinner.style.display='none';break;}toast.className=`${toastClass} show`;const duration=(type==='syncing'||type==='cached')?4000:2500;toastTimeout=setTimeout(()=>{toast.classList.remove('show');setTimeout(processToastQueue,400);},duration);}

        // Countdown
        function startCountdown(){const els={d:document.getElementById('days'),h:document.getElementById('hours'),m:document.getElementById('minutes'),s:document.getElementById('seconds')};if(!els.d||!els.h||!els.m||!els.s)return;const countDownDate=new Date("2025-12-12T00:00:00Z").getTime();countdownInterval=setInterval(()=>{const now=new Date().getTime(),dist=countDownDate-now;if(dist<0){clearInterval(countdownInterval);['d','h','m','s'].forEach(k=>els[k].textContent="00");return;}const d=Math.floor(dist/864e5),h=Math.floor((dist%864e5)/36e5),m=Math.floor((dist%36e5)/6e4),s=Math.floor((dist%6e4)/1e3);els.d.textContent=String(d).padStart(2,'0');els.h.textContent=String(h).padStart(2,'0');els.m.textContent=String(m).padStart(2,'0');els.s.textContent=String(s).padStart(2,'0');},1000);}

        // Cleanup
        window.cleanupAppListeners=()=>{if(countdownInterval)clearInterval(countdownInterval);if(saveTimeout)clearTimeout(saveTimeout);if(toastTimeout)clearTimeout(toastTimeout);if(unsubscribeSnapshot)unsubscribeSnapshot();console.log("App listeners cleaned up.");};

    </script>
</body>
</html>

