<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Last Fight (v5.1 - Custom Countdown)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --color-bg-main: #0a0e1a;
            --color-bg-gradient-start: #0f172a;
            --color-bg-gradient-end: #0a0e1a;
            --color-bg-card: #1e293b;
            --color-bg-card-gradient: #1a2536;
            --color-bg-header: #334155;
            --color-bg-hover: #475569;
            --color-bg-dropdown: #293548;
            --color-border: #3e4c62;
            --color-border-light: #64748b;
            --color-text-main: #f1f5f9;
            --color-text-dim: #94a3b8;
            --color-accent-green: #22c55e;
            --color-accent-blue: #3b82f6;
            --color-accent-red: #ef4444;
            --color-accent-yellow: #eab308;
            --color-accent-gold: #f59e0b;
            --color-accent-orange: #f97316;
            --color-accent-purple: #a855f7;
            --color-accent-pink: #ec4899;
            --color-accent-cyan: #06b6d4;
            --color-blue-400: #60a5fa;
            --color-green-400: #4ade80;
            --color-red-900: #7f1d1d;
            --color-red-500-t: rgba(239, 68, 68, 0.1);
            --color-blue-700-t: rgba(29, 78, 216, 0.3);
            --color-green-700-t: rgba(21, 128, 61, 0.3);
            --color-purple-700-t: rgba(126, 34, 206, 0.2);
            /* --- Countdown Modern Colors --- */
            --countdown-bg: linear-gradient(145deg, #2a3a50, #1a2536); /* Slightly lighter gradient */
            --countdown-border: var(--color-accent-purple);
            --countdown-text-bright: #e0e7ff; /* Lighter text */
            --countdown-label-text: var(--color-text-dim);
            --countdown-name-color: linear-gradient(90deg, #a855f7, #ec4899); /* Purple to Pink */
       }
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
            background-color: var(--color-bg-main);
            background-image: linear-gradient(to bottom, var(--color-bg-gradient-start), var(--color-bg-gradient-end));
            color: var(--color-text-main);
            min-height: 100vh;
       }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--color-bg-main); }
        ::-webkit-scrollbar-thumb { background: var(--color-border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-border-light); }

        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .modern-button {
            padding: 0.6rem 1.1rem; border-radius: 8px; font-weight: 600;
            transition: all 0.2s ease; cursor: pointer; border: none;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2), 0 2px 4px rgba(0,0,0,0.1);
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
       }
        .modern-button:hover { transform: translateY(-1px); box-shadow: 0 3px 6px rgba(0,0,0,0.2), 0 5px 10px rgba(0,0,0,0.1); }
        .modern-button:active { transform: translateY(0); }
        .modern-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .button-primary { background-color: var(--color-accent-blue); color: white; } .button-primary:hover:not(:disabled) { background-color: #2563eb; }
        .button-secondary { background-color: var(--color-bg-header); color: var(--color-text-main); } .button-secondary:hover:not(:disabled) { background-color: var(--color-border); }
        .button-danger { background-color: var(--color-accent-red); color: white; } .button-danger:hover:not(:disabled) { background-color: #dc2626; }
        .button-success { background-color: var(--color-accent-green); color: white; } .button-success:hover:not(:disabled) { background-color: #16a34a; }

        /* --- Compact Topic Item Margins --- */
        .priority-indicator { width: 6px; height: 6px; margin-right: 4px; }
        .progress-box { width: 36px; min-width: 36px; max-width: 36px; height: 36px; font-size: 0.65rem; }
        .topic-item { gap: 0.3rem; padding: 0.3rem 0.4rem; }
        .study-status { font-size: 0.55rem; padding: 0.1rem 0.3rem; margin-left: 0.3rem; }
        .edit-icon { padding: 4px; }

        .topic-name-container { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; gap: 0; }
        .topic-name { font-weight: 500; color: var(--color-text-main); white-space: normal; word-break: break-word; display: flex; align-items: center; }
        .topic-name-text {}
        .timed-note-display { font-size: 0.75rem; font-style: italic; color: var(--color-text-dim); line-height: 1; margin-top: 2px; }
        .edit-icon { flex-shrink: 0; color: var(--color-text-dim); cursor: pointer; padding: 5px; border-radius: 50%; transition: background-color 0.2s, color 0.2s; background: none; border: none; }
        .edit-icon:hover { background-color: var(--color-border); color: white; } .edit-icon.has-note { color: var(--color-accent-yellow); } .edit-icon.has-note:hover { color: #fde047; }

        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(120%); padding: 12px 20px; border-radius: 8px; font-weight: 600; display: flex; align-items: center; gap: 10px; z-index: 1000; transition: opacity 0.3s, transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); opacity: 0; border: 1px solid transparent; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        @media (min-width: 768px) { #toast { left: auto; right: 20px; transform: translateY(120%); } #toast.show { transform: translateY(0); } }

        .spinner { width: 18px; height: 18px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; } @keyframes spin { to { transform: rotate(360deg); } }
        .spinner-dark { border-color: rgba(0,0,0,0.2); border-top-color: #333; }

        .topic-item.dragging { opacity: 0.5; background: var(--color-bg-header); transform: scale(1.02); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .column-section.drag-over { border: 2px dashed var(--color-accent-blue); background-color: rgba(59, 130, 246, 0.05); border-radius: 8px; margin: -2px; padding-bottom: 0.5rem; }

        [contenteditable="true"] { -webkit-user-modify: read-write-plaintext-only; }
        [contenteditable="true"]:empty:before { content: attr(placeholder); color: var(--color-text-dim); opacity: 0.7; pointer-events: none; display: block; }
        [contenteditable="true"]:focus { outline: 2px solid var(--color-accent-blue); border-radius: 4px; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); background-color: rgba(59, 130, 246, 0.1); }

        .date-card { background-color: var(--color-bg-card); background-image: linear-gradient(to bottom, var(--color-bg-card), var(--color-bg-card-gradient)); border: 1px solid var(--color-border); border-radius: 12px; margin-bottom: 1.5rem; overflow: hidden; position: relative; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.15), 0 2px 4px -2px rgba(0, 0, 0, 0.1); transition: box-shadow 0.2s ease; }
        .date-card:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -4px rgba(0, 0, 0, 0.1); }

        /* --- Compact Date Header --- */
        .date-header { padding: 0.5rem 1rem; flex-wrap: nowrap; /* Try to keep on one line */ }
        .date-header-text { font-size: 1rem; padding: 0.25rem 0.6rem; min-width: 90px; flex-shrink: 0; }
        .card-progress-container { min-width: 120px; /* Reduced min-width */ gap: 0.5rem; }
        .card-progress-bar-bg { height: 6px; }
        .card-progress-text { font-size: 0.8rem; }
        .card-progress-count { font-size: 0.7rem; padding: 0.1rem 0.4rem; }

        .column-section { padding: 0.75rem 1.25rem 1rem; border-bottom: 1px solid var(--color-border); } .column-section:last-child { border-bottom: none; }
        .column-title { display: inline-block; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; padding: 0.25rem 0.6rem; border-radius: 6px; margin-bottom: 0.75rem; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .date-card[data-table-id="table1"] .column-title { background-color: var(--color-green-700-t); color: var(--color-green-400); border: 1px solid var(--color-accent-green); }
        .date-card[data-table-id="table2"] .column-title { background-color: var(--color-blue-700-t); color: var(--color-blue-400); border: 1px solid var(--color-accent-blue); }

        .delete-row-btn { color: var(--color-text-dim); opacity: 0.6; transition: all 0.2s ease; padding: 0.35rem; border-radius: 50%; flex-shrink: 0; background: none; border: none; cursor: pointer;}
        .delete-row-btn:hover { color: var(--color-accent-red); opacity: 1; transform: scale(1.1); background-color: var(--color-red-500-t); }

        .card-footer { padding: 0.75rem 1.25rem; background-color: rgba(0,0,0,0.1); border-top: 1px solid var(--color-border); }
        .add-topic-btn-card-single { width: 100%; text-align: center; font-size: 0.875rem; color: var(--color-text-dim); padding: 0.6rem; border: 2px dashed var(--color-border); border-radius: 8px; transition: all 0.2s; font-weight: 600; background: none; cursor: pointer; }
        .add-topic-btn-card-single:hover { color: var(--color-blue-400); border-color: var(--color-accent-blue); background-color: rgba(59, 130, 246, 0.1); }

        .view-toggle-btn { padding: 0.6rem 1.2rem; font-weight: 600; color: var(--color-text-dim); border-bottom: 3px solid transparent; transition: color 0.2s, border-color 0.2s; margin-bottom: -1px; background: none; border-top: none; border-left: none; border-right: none; cursor: pointer; }
        .view-toggle-btn.active { color: var(--color-accent-blue); border-bottom-color: var(--color-accent-blue); }
        .view-toggle-btn:hover:not(.active) { color: var(--color-text-main); }

        .priority-btn { display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.8rem; border: 1px solid var(--color-border); border-radius: 6px; font-weight: 500; color: var(--color-text-dim); transition: all 0.2s; background-color: var(--color-bg-header); cursor: pointer; }
        .priority-btn .priority-indicator { margin-right: 0; }
        .priority-btn:hover { background-color: var(--color-border); color: var(--color-text-main); }
        .priority-btn.active { color: var(--color-text-main); font-weight: 600; background-color: var(--color-bg-hover); }
        .priority-btn[data-priority="high"].active { border-color: var(--color-accent-red); box-shadow: 0 0 5px rgba(239, 68, 68, 0.3); background-color: var(--color-red-500-t); }
        .priority-btn[data-priority="medium"].active { border-color: var(--color-accent-yellow); box-shadow: 0 0 5px rgba(234, 179, 8, 0.3); background-color: rgba(234, 179, 8, 0.1); }
        .priority-btn[data-priority="low"].active { border-color: var(--color-border-light); background-color: var(--color-border); }

        /* --- Modal Styles --- */
        .modal-backdrop { position: fixed; inset: 0; z-index: 40; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; padding: 1rem; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-backdrop.show { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--color-bg-card); border: 1px solid var(--color-border-light);
            border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            width: 100%; max-width: 550px;
            transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column; /* Added for scrolling */
            max-height: 90vh; /* Added for scrolling */
       }
        .modal-backdrop.show .modal-content { transform: scale(1); }
        #confirm-modal .modal-content { max-width: 400px; max-height: auto; }
        #calendar-modal .modal-content { max-width: 400px; max-height: auto; }
        #settings-modal .modal-content { max-width: 600px; }

        /* --- Modal Scrollbar --- */
        .modal-body-scrollable {
            padding: 1.75rem;
            overflow-y: auto;
            max-height: 70vh; /* This makes the body scroll, not header/footer */
       }
        #settings-modal .modal-body-scrollable {
            padding: 0; /* Settings modal has its own padding */
       }
        /* Modal header/footer (for Add/Edit) */
        .modal-header { padding: 1.5rem 1.75rem 0; }
        .modal-footer { padding: 1.5rem 1.75rem; border-top: 1px solid var(--color-border); background-color: rgba(0,0,0,0.1); }


        #confirm-modal { z-index: 60; } /* Higher than settings/edit */
        #settings-modal { z-index: 50; }
        #edit-modal { z-index: 50; }
        #calendar-modal { z-index: 55; } /* Higher than settings/edit */

        .custom-dropdown { position: relative; }
        .custom-dropdown-button { display: flex; align-items: center; justify-content: space-between; width: 100%; background-color: var(--color-bg-header); border: 1px solid var(--color-border); border-radius: 8px; padding: 0.6rem 0.8rem; color: var(--color-text-main); transition: border-color 0.2s, box-shadow 0.2s; cursor: pointer; text-align: left; }
        .custom-dropdown-button:focus, .custom-dropdown-button.active { outline: none; border-color: var(--color-accent-blue); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        .custom-dropdown-button .arrow { width: 1em; height: 1em; margin-left: 0.5rem; transition: transform 0.2s; color: var(--color-text-dim); }
        .custom-dropdown-button.active .arrow { transform: rotate(180deg); }
        .custom-dropdown-options { position: absolute; top: calc(100% + 4px); left: 0; right: 0; z-index: 10; background-color: var(--color-bg-dropdown); border: 1px solid var(--color-border-light); border-radius: 8px; max-height: 200px; overflow-y: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.3); opacity: 0; visibility: hidden; transform: translateY(-10px); transition: opacity 0.2s, visibility 0.2s, transform 0.2s; }
        .custom-dropdown-options.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .custom-dropdown-option { padding: 0.6rem 0.8rem; cursor: pointer; color: var(--color-text-main); transition: background-color 0.15s; border-bottom: 1px solid var(--color-border); }
        .custom-dropdown-option:last-child { border-bottom: none; }
        .custom-dropdown-option:hover { background-color: var(--color-bg-hover); }
        .custom-dropdown-option.selected { background-color: var(--color-accent-blue); color: white; font-weight: 600; }

        #calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        #calendar-month-year { font-size: 1.125rem; font-weight: 600; color: var(--color-text-main); }
        #calendar-header button { background: var(--color-bg-header); border: 1px solid var(--color-border); border-radius: 50%; width: 34px; height: 34px; display: flex; justify-content: center; align-items: center; transition: background-color 0.2s; cursor: pointer; }
        #calendar-header button:hover { background: var(--color-border); } #calendar-header button svg { color: var(--color-text-dim); }
        #calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 0.5rem; }
        #calendar-weekdays div { text-align: center; font-size: 0.75rem; font-weight: 600; color: var(--color-text-dim); }
        #calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { background: var(--color-bg-header); border: 1px solid var(--color-border); border-radius: 6px; text-align: center; padding: 0.5rem 0; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; position: relative; }
        .calendar-day:hover:not(.disabled):not(.empty) { background: var(--color-border); }
        .calendar-day.empty { background: transparent; border-color: transparent; cursor: default; }
        .calendar-day.today { border-color: var(--color-accent-yellow); color: var(--color-accent-yellow); font-weight: 700; }
        .calendar-day.selected { background: var(--color-accent-blue); border-color: var(--color-accent-blue); color: white; font-weight: 700; }
        .calendar-day.disabled { background: var(--color-bg-card); color: var(--color-text-dim); opacity: 0.5; cursor: not-allowed; border-color: transparent; }
        .calendar-day.has-card { border-color: var(--color-accent-blue); box-shadow: 0 0 5px var(--color-accent-blue); }
        .calendar-day.has-card::after { content: ''; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); width: 5px; height: 5px; border-radius: 50%; background-color: var(--color-accent-blue); }

        /* --- Modern Countdown Styles --- */
        #countdown-container {
            background: var(--countdown-bg);
            border: 1px solid var(--countdown-border);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            box-shadow: 0 6px 12px rgba(0,0,0,0.3), inset 0 1px 2px rgba(255, 255, 255, 0.1);
            text-align: center;
       }
        #countdown-name {
            font-size: 1.5rem; /* Larger */
            font-weight: 800; /* Bolder */
            margin-bottom: 0.75rem;
            background: var(--countdown-name-color);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
       }
        #countdown { display: flex; justify-content: center; gap: 1rem; }
        .countdown-segment { display: flex; flex-direction: column; align-items: center; min-width: 50px; }
        .countdown-number {
            font-family: 'Courier New', Courier, monospace;
            font-size: 2rem; /* Larger numbers */
            font-weight: 700;
            line-height: 1;
            color: var(--countdown-text-bright);
            padding: 0.25rem 0;
       }
        .countdown-label {
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--countdown-label-text);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-top: 2px;
       }


        .add-row-button { margin-top: 1rem; width: 100%; font-size: 1rem; color: var(--color-text-dim); font-semibold; padding: 0.75rem; border: 2px dashed var(--color-border); border-radius: 10px; transition: all 0.2s; background: none; cursor: pointer; }
        .add-row-button:hover { color: var(--color-text-main); border-color: var(--color-border-light); background-color: rgba(255, 255, 255, 0.03); }
        #open-calendar-btn { color: var(--color-blue-400); border-color: var(--color-accent-blue); background-color: var(--color-blue-700-t); }
        #open-calendar-btn:hover { color: white; border-color: var(--color-blue-400); background-color: rgba(59, 130, 246, 0.2); }

        #calendar-nav-btn, #settings-btn {
            background-color: var(--color-bg-header); border: 1px solid var(--color-border); border-radius: 8px;
            padding: 0.5rem; line-height: 1; cursor: pointer; transition: all 0.2s;
            color: var(--color-text-dim);
       }
        #calendar-nav-btn:hover, #settings-btn:hover { background-color: var(--color-border); color: var(--color-text-main); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* --- Login Screen --- */
        #login-screen {
            position: fixed; inset: 0; z-index: 100;
            display: flex; /* Changed from default hidden */
            align-items: center; justify-content: center;
            background-color: var(--color-bg-main);
            background-image: linear-gradient(to bottom, var(--color-bg-gradient-start), var(--color-bg-gradient-end));
            transition: opacity 0.5s, visibility 0.5s;
            opacity: 1; /* Default visible */
            visibility: visible;
       }
        #login-screen.hidden { /* JS adds this class */
           opacity: 0;
           visibility: hidden;
        }

        .login-card {
            background-color: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: 12px; padding: 2rem;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
       }

        /* --- Settings Modal Horizontal Tabs --- */
        .settings-nav {
            display: flex; /* Already flex */
            border-bottom: 1px solid var(--color-border);
            /* Remove padding, handled by buttons now */
            background-color: var(--color-bg-header);
            border-top-left-radius: 11px;
            border-top-right-radius: 11px;
            overflow: hidden; /* Ensure buttons fit */
       }
        .settings-nav-btn {
            flex-grow: 1; /* Make buttons share space */
            text-align: center; /* Center text */
            padding: 0.85rem 1rem; /* Adjust padding */
            font-weight: 600;
            color: var(--color-text-dim);
            border: none; background: none; cursor: pointer;
            border-bottom: 3px solid transparent;
            /* margin-bottom: -1px; Remove margin overlap */
            transition: color 0.2s, border-color 0.2s, background-color 0.2s; /* Added background transition */
       }
        .settings-nav-btn.active {
            color: var(--color-accent-blue);
            border-bottom-color: var(--color-accent-blue);
            background-color: rgba(59, 130, 246, 0.1); /* Slight background tint when active */
       }
        .settings-nav-btn:hover:not(.active) {
            color: var(--color-text-main);
            background-color: rgba(255, 255, 255, 0.05); /* Hover background */
        }


        .settings-tab-content { padding: 1.75rem; }
        .settings-account-card {
            display: flex; align-items: center; gap: 1rem;
            background-color: var(--color-bg-header);
            padding: 1rem; border-radius: 8px;
            border: 1px solid var(--color-border);
       }
        .settings-account-card img { width: 48px; height: 48px; border-radius: 50%; }
        .settings-account-info span { display: block; }
        .settings-account-info .name { font-weight: 600; color: white; }
        .settings-account-info .email { font-size: 0.875rem; color: var(--color-text-dim); }

        .settings-group { margin-bottom: 1.5rem; }
        .settings-group-title {
            font-size: 0.875rem; font-weight: 700; color: var(--color-text-dim);
            text-transform: uppercase; letter-spacing: 0.5px;
            margin-bottom: 0.75rem; border-bottom: 1px solid var(--color-border);
            padding-bottom: 0.5rem;
       }
        .settings-input { /* General input style for settings */
            width: 100%;
            padding: 0.6rem 0.8rem;
            background-color: var(--color-bg-header);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text-main);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .settings-input:focus {
             outline: none; border-color: var(--color-accent-blue);
             box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .custom-study-type-item {
            display: flex; gap: 0.75rem; align-items: center; margin-bottom: 0.75rem;
       }
        .custom-study-type-item input {
             flex-grow: 1;
             /* Use general settings input style */
             padding: 0.6rem 0.8rem;
             background-color: var(--color-bg-header);
             border: 1px solid var(--color-border);
             border-radius: 8px;
             color: var(--color-text-main);
             transition: border-color 0.2s, box-shadow 0.2s;
        }
        .custom-study-type-item input:focus {
             outline: none; border-color: var(--color-accent-blue);
             box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .custom-study-type-item .delete-btn {
            color: var(--color-text-dim); padding: 0.5rem; border-radius: 50%;
            transition: all 0.2s; background: none; border: none; cursor: pointer;
       }
        .custom-study-type-item .delete-btn:hover {
            color: var(--color-accent-red);
            background-color: var(--color-red-500-t);
       }
       /* Reduce Overall Progress Card Height */
       #overall-progress-card { padding: 1rem; } /* Reduced padding */

    </style>
</head>
<body ondragover="event.preventDefault()">

    <!--
    ============================================================================
    v5.1: LOGIN SCREEN (Default Visible, JS hides if logged in)
    ============================================================================
    -->
    <div id="login-screen">
        <div class="login-card">
            <h1 class="text-3xl font-bold text-white mb-2">
                Last Fight <span class="bg-clip-text text-transparent bg-gradient-to-r from-green-400 to-blue-400">Tracker</span>
            </h1>
            <p class="text-slate-400 mb-6">Please sign in to continue</p>
            <button id="google-login-btn" class="modern-button button-primary w-full">
                <!-- Google SVG Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 48 48">
                    <path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path>
                    <path fill="#FF3D00" d="M6.306 14.691c-1.645 3.119-2.603 6.61-2.603 10.309s.958 7.19 2.603 10.309l7.37-5.73C12.052 26.822 11.8 25.448 11.8 24s.252-2.822 1.876-5.579l-7.37-5.73z"></path>
                    <path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-4.819C28.907 36.654 26.561 38 24 38c-3.313 0-6.22-1.661-8.13-4.124l-7.37 5.73C10.899 41.623 17.02 44 24 44z"></path>
                    <path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-0.792 2.237-2.231 4.166-4.087 5.579l7.37 5.73C40.662 35.894 44 30.561 44 24c0-1.341-.138-2.65-.389-3.917z"></path>
                </svg>
                <span id="google-login-text">Sign In with Google</span>
                <div id="google-login-spinner" class="spinner hidden"></div>
            </button>
            <p id="google-login-error" class="text-red-400 text-sm mt-4 hidden"></p>
        </div>
    </div>

    <!--
    ============================================================================
    v5.1: MAIN APP CONTAINER (Default Hidden, JS shows if logged in)
    ============================================================================
    -->
    <div id="main-app-container" class="hidden">
        <div class="max-w-7xl mx-auto px-4 md:px-8 pt-6 md:pt-8">
            <!-- Header -->
            <div class="flex flex-col md:flex-row justify-between md:items-center gap-6 mb-8">
                <div class="flex items-center justify-center md:justify-start gap-4">
                    <h1 class="text-3xl md:text-4xl font-bold text-white text-center md:text-left font-sans">
                        Last Fight
                        <span class="bg-clip-text text-transparent bg-gradient-to-r from-green-400 to-blue-400">Tracker</span>
                    </h1>
                    <button id="calendar-nav-btn" title="Click: Go to Today | Double Click: Open Calendar">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    </button>
                    <!-- Settings Button -->
                    <button id="settings-btn" title="Settings">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-settings"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    </button>
                </div>

                <!-- v5.1: Modern Countdown -->
                <div class="flex justify-center md:justify-end w-full md:w-auto">
                    <div id="countdown-container">
                        <div id="countdown-name">Exam Countdown</div>
                        <div id="countdown">
                            <div class="countdown-segment">
                                <span id="days" class="countdown-number">00</span>
                                <span class="countdown-label">Days</span>
                            </div>
                            <div class="countdown-segment">
                                <span id="hours" class="countdown-number">00</span>
                                <span class="countdown-label">Hours</span>
                            </div>
                            <div class="countdown-segment">
                                <span id="minutes" class="countdown-number">00</span>
                                <span class="countdown-label">Mins</span>
                            </div>
                            <div class="countdown-segment">
                                <span id="seconds" class="countdown-number">00</span>
                                <span class="countdown-label">Secs</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Overall Progress Bar (Single Card) -->
             <div id="overall-progress-card" class="bg-slate-800 p-4 rounded-lg card-shadow border border-slate-700 mb-8">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-lg font-semibold text-white">Overall Progress (Targets)</span>
                    <span id="overall-progress-text" class="text-lg font-bold text-green-400">0%</span>
                </div>
                <div class="w-full bg-slate-700 rounded-full h-3 overflow-hidden card-shadow"> <!-- Reduced height h-3 -->
                    <div id="overall-progress-bar" class="bg-green-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <div class="text-right mt-1">
                    <span id="t1_task_counter" class="bg-green-700/30 text-green-300 text-xs font-semibold px-2 py-0.5 rounded-full opacity-0 transition-opacity">0 / 0 Done</span>
                </div>
            </div>

             <!-- Daily Plan Progress Removed -->

            <!-- View Toggles -->
            <div class="mb-8 border-b border-slate-700 flex justify-center md:justify-start">
                <button id="view-toggle-table1" class="view-toggle-btn active" data-view="table1">Targets</button>
                <button id="view-toggle-table2" class="view-toggle-btn" data-view="table2">Daily Plan View</button>
            </div>
            <!-- Loading Spinner (for data) -->
            <div id="loading" class="text-center py-20"> <div class="spinner" style="margin: 0 auto; width: 40px; height: 40px; border-width: 4px;"></div> <p class="mt-4 text-lg text-slate-400">Loading Dashboard...</p> </div>
            <!-- Main Content -->
            <div id="content" class="hidden pb-8">
                <div id="main-content-area">
                    <div id="table1-section" class="mb-10"> <div id="table1-cards"></div> <button id="add-row-t1" class="add-row-button">+ Add "New Date" Card</button> </div>
                    <div id="table2-section" class="mb-10 hidden"> <div id="table2-cards"></div> <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> <button id="open-calendar-btn" class="add-row-button">Add Card by Date</button> <button id="add-row-t2" class="add-row-button">+ Add "New Date" Card</button> </div> </div>
                </div>
            </div>
        </div>
    </div>

    <!--
    ============================================================================
    MODALS
    ============================================================================
    -->

    <!-- Toast Notification -->
    <div id="toast"> <div id="toast-spinner" class="spinner"></div> <span id="toast-message">Syncing...</span> </div>

    <!-- Add Topic Modal -->
    <div id="add-topic-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-xl font-semibold text-white">Add New Topic</h3>
            </div>
            <!-- Scrollable Body -->
            <div class="modal-body-scrollable">
                <div class="mb-5">
                    <label for="add-topic-modal-name" class="block text-sm font-medium text-slate-300 mb-1">Topic Name</label>
                    <input type="text" id="add-topic-modal-name" class="w-full p-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
                </div>
                <div class="mb-4">
                    <label for="add-topic-modal-timed-note" class="block text-sm font-medium text-slate-300 mb-1">Timed Note <span class="text-xs text-slate-400">(Visible on card)</span></label>
                    <input type="text" id="add-topic-modal-timed-note" class="w-full p-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-white" placeholder="e.g., '30 min' or '10:00 AM'">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Hardness</label>
                        <div class="custom-dropdown" data-target-input="add-topic-modal-hardness-value">
                            <button type="button" class="custom-dropdown-button"> <span class="selected-value">Medium</span> <svg class="arrow w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 8l4 4 4-4"/></svg> </button>
                            <div class="custom-dropdown-options"> <div class="custom-dropdown-option" data-value="easy">Easy</div> <div class="custom-dropdown-option selected" data-value="medium">Medium</div> <div class="custom-dropdown-option" data-value="hard">Hard</div> </div>
                            <input type="hidden" id="add-topic-modal-hardness-value" value="medium">
                        </div>
                    </div>
                    <div id="add-topic-targets-fields">
                        <label class="block text-sm font-medium text-slate-300 mb-1">Subject</label>
                        <div class="custom-dropdown" data-target-input="add-topic-modal-subject-value">
                            <button type="button" class="custom-dropdown-button"> <span class="selected-value">Phy</span> <svg class="arrow w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 8l4 4 4-4"/></svg> </button>
                            <div class="custom-dropdown-options" id="add-topic-modal-subject-options"> </div>
                            <input type="hidden" id="add-topic-modal-subject-value" value="Phy">
                        </div>
                    </div>
                    <div id="add-topic-daily-fields">
                        <label class="block text-sm font-medium text-slate-300 mb-1">Session</label>
                        <div class="custom-dropdown" data-target-input="add-topic-modal-session-value">
                            <button type="button" class="custom-dropdown-button"> <span class="selected-value">Morning Session</span> <svg class="arrow w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 8l4 4 4-4"/></svg> </button>
                            <div class="custom-dropdown-options" id="add-topic-modal-session-options"> </div>
                            <input type="hidden" id="add-topic-modal-session-value" value="Morning Session">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Study Type</label>
                        <!-- Study Type dropdown is dynamic -->
                        <div class="custom-dropdown" data-target-input="add-topic-modal-study-value">
                            <button type="button" class="custom-dropdown-button"> <span class="selected-value">Select...</span> <svg class="arrow w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 8l4 4 4-4"/></svg> </button>
                            <div class="custom-dropdown-options" id="add-topic-modal-study-options">
                                <!-- Options will be populated by JS -->
                            </div>
                            <input type="hidden" id="add-topic-modal-study-value" value="">
                        </div>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-slate-300 mb-2">Priority</label>
                    <div id="add-topic-priority-selector" class="flex flex-wrap gap-2">
                        <button type="button" data-priority="high" class="priority-btn group"><span class="priority-indicator priority-high"></span> High</button>
                        <button type="button" data-priority="medium" class="priority-btn group"><span class="priority-indicator priority-medium"></span> Medium</button>
                        <button type="button" data-priority="low" class="priority-btn group active"><span class="priority-indicator priority-low"></span> Low</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer flex justify-end gap-3">
                <button id="add-topic-modal-cancel" class="modern-button button-secondary">Cancel</button>
                <button id="add-topic-modal-save" class="modern-button button-primary">Save Topic</button>
            </div>
        </div>
    </div>

    <!-- Edit Topic Modal -->
    <div id="edit-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-xl font-semibold text-white">Edit Topic</h3>
            </div>
            <!-- Scrollable Body -->
            <div class="modal-body-scrollable">
                <div class="mb-4">
                    <label for="modal-topic-name" class="block text-sm font-medium text-slate-300 mb-1">Topic Name</label>
                    <input type="text" id="modal-topic-name" class="w-full p-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
                </div>
                <div class="mb-4">
                    <label for="modal-topic-timed-note" class="block text-sm font-medium text-slate-300 mb-1">Timed Note <span class="text-xs text-slate-400">(Visible on card)</span></label>
                    <input type="text" id="modal-topic-timed-note" class="w-full p-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-white" placeholder="e.g., '30 min' or '10:00 AM'">
                </div>
                <div class="mb-4">
                    <label for="modal-topic-note" class="block text-sm font-medium text-slate-300 mb-1">Main Notes <span class="text-xs text-slate-400">(Hidden)</span></label>
                    <textarea id="modal-topic-note" rows="4" class="w-full p-2 bg-slate-700 border border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-white" placeholder="Add your detailed notes here..."></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-5">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Hardness</label>
                        <div class="custom-dropdown" data-target-input="modal-topic-hardness-value">
                            <button type="button" class="custom-dropdown-button"> <span class="selected-value">Medium</span> <svg class="arrow w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 8l4 4 4-4"/></svg> </button>
                            <div class="custom-dropdown-options"> <div class="custom-dropdown-option" data-value="easy">Easy</div> <div class="custom-dropdown-option" data-value="medium">Medium</div> <div class="custom-dropdown-option" data-value="hard">Hard</div> </div>
                            <input type="hidden" id="modal-topic-hardness-value" value="medium">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Study Type</label>
                        <!-- Study Type dropdown is dynamic -->
                        <div class="custom-dropdown" data-target-input="modal-topic-study-value">
                            <button type="button" class="custom-dropdown-button"> <span class="selected-value">Select...</span> <svg class="arrow w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 8l4 4 4-4"/></svg> </button>
                            <div class="custom-dropdown-options" id="modal-topic-study-options">
                                <!-- Options will be populated by JS -->
                            </div>
                            <input type="hidden" id="modal-topic-study-value" value="">
                        </div>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-slate-300 mb-2">Priority</label>
                    <div id="modal-priority-selector" class="flex flex-wrap gap-2">
                        <button type="button" data-priority="high" class="priority-btn group"><span class="priority-indicator priority-high"></span> High</button>
                        <button type="button" data-priority="medium" class="priority-btn group"><span class="priority-indicator priority-medium"></span> Medium</button>
                        <button type="button" data-priority="low" class="priority-btn group"><span class="priority-indicator priority-low"></span> Low</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer flex justify-between items-center flex-wrap gap-4">
                <button id="modal-delete" class="modern-button button-danger">Delete Topic</button>
                <div class="flex gap-3">
                    <button id="modal-cancel" class="modern-button button-secondary">Cancel</button>
                    <button id="modal-save" class="modern-button button-success">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal-backdrop">
        <div class="modal-content">
             <h3 class="text-xl font-semibold mb-2 text-white p-6 pb-0">Are you sure?</h3>
             <p id="confirm-message" class="text-slate-300 mb-6 p-6 pt-2">Action cannot be undone.</p>
             <div class="modal-footer flex justify-end gap-3">
                <button id="confirm-cancel" class="modern-button button-secondary">Cancel</button>
                <button id="confirm-yes" class="modern-button button-danger">Yes, Delete</button>
            </div>
        </div>
    </div>

    <!-- Calendar Modal -->
    <div id="calendar-modal" class="modal-backdrop">
        <div class="modal-content p-6">
             <div id="calendar-header"> <button type="button" id="calendar-prev-month"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="text-slate-400" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/></svg></button> <div id="calendar-month-year" class="text-white">Month Year</div> <button type="button" id="calendar-next-month"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="text-slate-400" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg></button> </div>
             <div id="calendar-weekdays" class="text-slate-400"><div>Su</div><div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div></div>
             <div id="calendar-days"></div>
             <button id="calendar-cancel" class="w-full modern-button button-secondary mt-4">Cancel</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-backdrop">
        <div class="modal-content p-0">
            <!-- Settings Header / Nav -->
            <div class="settings-nav">
                <button id="settings-nav-account" class="settings-nav-btn active" data-tab="account">Account</button>
                <button id="settings-nav-custom" class="settings-nav-btn" data-tab="custom">Customizations</button>
            </div>

            <!-- Account Tab -->
            <div id="settings-tab-account" class="settings-tab-content">
                <div class="settings-account-card mb-6">
                    <img id="settings-user-img" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5NDRhYjgiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2EtbGluZWpvaW49InJvdW5kIiBjbGFzcz0iZmVhdGhlciBmZWF0aGVyLXVzZXIiPjxwYXRoIGQ9Ik0yMCAyMWE4IDggMCAwIDAtMTYgMCI+PC9wYXRoPjxjaXJjbGUgY3g9IjEyIiBjeT0iNyIgcj0iNCI+PC9jaXJjbGU+PC9zdmc+" alt="User Avatar">
                    <div class="settings-account-info">
                        <span id="settings-user-name" class="name">Not Signed In</span>
                        <span id="settings-user-email" class="email">Sign in to sync your data</span>
                    </div>
                </div>
                <button id="google-signout-btn" class="modern-button button-danger w-full">Sign Out</button>
            </div>

            <!-- Customizations Tab -->
            <div id="settings-tab-custom" class="settings-tab-content hidden">
                <!-- Countdown Settings -->
                 <div class="settings-group">
                    <h4 class="settings-group-title">Countdown Timer</h4>
                    <p class="text-sm text-slate-400 mb-4">Set a name and target date for the main countdown timer.</p>
                    <div class="mb-4">
                        <label for="settings-countdown-name" class="block text-sm font-medium text-slate-300 mb-1">Countdown Name</label>
                        <input type="text" id="settings-countdown-name" class="settings-input" placeholder="e.g., Exam Day">
                    </div>
                    <div class="mb-4">
                        <label for="settings-countdown-date" class="block text-sm font-medium text-slate-300 mb-1">Target Date</label>
                        <input type="date" id="settings-countdown-date" class="settings-input">
                    </div>
                </div>

                <!-- Study Types -->
                <div class="settings-group">
                    <h4 class="settings-group-title">Study Types</h4>
                    <p class="text-sm text-slate-400 mb-4">Add, remove, or rename your study type categories.</p>
                    <div id="custom-study-type-list">
                        <!-- JS will populate this -->
                    </div>
                    <button id="settings-add-study-type" class="modern-button button-secondary w-full mt-2">
                        + Add New Study Type
                    </button>
                </div>

                <div class="modal-footer -m-[1.75rem] mt-6"> <!-- Adjusted negative margin to match padding -->
                    <div class="flex justify-end gap-3">
                        <button id="settings-cancel-btn" class="modern-button button-secondary">Cancel</button>
                        <button id="settings-save-btn" class="modern-button button-success">Save Changes</button>
                    </div>
                </div>
            </div>

        </div>
    </div>


    <!--
    ============================================================================
    APP JAVASCRIPT (v5.1)
    ============================================================================
    -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            setDoc,
            onSnapshot,
            enableIndexedDbPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // App State
        let db, auth;
        let dbDocRef, settingsDocRef;
        let unsubscribeSnapshot = null, unsubscribeSettings = null;
        let countdownInterval = null, saveTimeout = null, toastTimeout = null, calendarClickTimer = null;
        let isFirstLoad = true;
        let pendingChanges = false;
        let currentView = 'table1';
        let confirmCallback = null;
        let calendarState = { month: new Date().getMonth(), year: new Date().getFullYear() };
        const toastQueue = [];
        let isToastShowing = false;
        let currentUserId = null;
        let settingsLoaded = false; // Flag to manage settings/data load order

        // Default app settings for new users
        const DEFAULT_STUDY_TYPES = [
            { key: 'mqb', name: 'MQB' }, { key: 'ret', name: 'Retina QB' },
            { key: 'med', name: 'Meditrics' }, { key: 'camp', name: 'Campus Exam' },
            { key: 'week', name: 'Weekly Exam' }, { key: 'rev', name: 'Revision Class' },
            { key: 'new', name: '1st Time Reading' }, { key: 'secret', name: 'Secret Files' }
        ];
        const DEFAULT_COUNTDOWN_NAME = "Final Countdown";
        const DEFAULT_COUNTDOWN_DATE = "2025-12-12"; // Keep a default fallback

        // Main app settings state
        const appSettings = {
            customStudyTypes: JSON.parse(JSON.stringify(DEFAULT_STUDY_TYPES)),
            countdownName: DEFAULT_COUNTDOWN_NAME,
            countdownDate: DEFAULT_COUNTDOWN_DATE,
            countdownMaxDays: 365 // Will be calculated dynamically
        };

        // App Data State
        let appData = { completedTopics: {} };
        let tableData = { table1: {}, table2: {} };
        const DEFAULT_TABLE_DATA = { table1: {}, table2: {} };

        // Constants
        const columnHeaders = {
            table1: ["Phy", "Chem", "Bio", "GK", "English"],
            table2: ["Morning Session", "Noon Session", "Night Session", "Exam"]
        };
        const progressSteps = [0, 20, 40, 60, 80, 100];
        const today = new Date();
        const hardnessMap = { easy: "E", medium: "M", hard: "H" };

        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const mainAppContainer = document.getElementById('main-app-container');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const googleLoginText = document.getElementById('google-login-text');
        const googleLoginSpinner = document.getElementById('google-login-spinner');
        const googleLoginError = document.getElementById('google-login-error');

        const loadingEl = document.getElementById('loading'), contentEl = document.getElementById('content'),
              modalEl = document.getElementById('edit-modal'), modalTopicName = document.getElementById('modal-topic-name'),
              modalTopicNote = document.getElementById('modal-topic-note'), modalTopicTimedNote = document.getElementById('modal-topic-timed-note'),
              addTopicModalEl = document.getElementById('add-topic-modal'), addTopicModalName = document.getElementById('add-topic-modal-name'),
              table1Section = document.getElementById('table1-section'), table2Section = document.getElementById('table2-section'),
              table1CardsContainer = document.getElementById('table1-cards'), table2CardsContainer = document.getElementById('table2-cards'),
              viewToggleBtnTable1 = document.getElementById('view-toggle-table1'), viewToggleBtnTable2 = document.getElementById('view-toggle-table2'),
              addRowBtnTable1 = document.getElementById('add-row-t1'), addRowBtnTable2 = document.getElementById('add-row-t2'),
              confirmModalEl = document.getElementById('confirm-modal'), confirmMessageEl = document.getElementById('confirm-message'),
              calendarModalEl = document.getElementById('calendar-modal'), calendarDaysEl = document.getElementById('calendar-days'),
              calendarMonthYearEl = document.getElementById('calendar-month-year'), calendarNavBtn = document.getElementById('calendar-nav-btn');

        const addHardnessInput = document.getElementById('add-topic-modal-hardness-value'),
              addSubjectInput = document.getElementById('add-topic-modal-subject-value'),
              addSessionInput = document.getElementById('add-topic-modal-session-value'),
              addStudyInput = document.getElementById('add-topic-modal-study-value'),
              editHardnessInput = document.getElementById('modal-topic-hardness-value'),
              editStudyInput = document.getElementById('modal-topic-study-value');

        // Settings Modal DOM Elements
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModalEl = document.getElementById('settings-modal');
        const settingsNavAccount = document.getElementById('settings-nav-account');
        const settingsNavCustom = document.getElementById('settings-nav-custom');
        const settingsTabAccount = document.getElementById('settings-tab-account');
        const settingsTabCustom = document.getElementById('settings-tab-custom');
        const settingsUserImg = document.getElementById('settings-user-img');
        const settingsUserName = document.getElementById('settings-user-name');
        const settingsUserEmail = document.getElementById('settings-user-email');
        const googleSignoutBtn = document.getElementById('google-signout-btn');
        const customStudyTypeList = document.getElementById('custom-study-type-list');
        const settingsAddStudyTypeBtn = document.getElementById('settings-add-study-type');
        const settingsCancelBtn = document.getElementById('settings-cancel-btn');
        const settingsSaveBtn = document.getElementById('settings-save-btn');
        const settingsCountdownNameInput = document.getElementById('settings-countdown-name');
        const settingsCountdownDateInput = document.getElementById('settings-countdown-date');

        // Countdown Elements
        const countdownNameEl = document.getElementById('countdown-name');
        const countdownEls = {
            d: document.getElementById('days'), h: document.getElementById('hours'),
            m: document.getElementById('minutes'), s: document.getElementById('seconds')
        };

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            calendarState = { month: today.getMonth(), year: today.getFullYear() };
            const savedView = localStorage.getItem('lastFightTrackerView');
            if (savedView === 'table2') currentView = 'table2';
            updateViewToggleUI();

            // Populate static dropdowns ONLY
            populateSubjectAndSessionDropdowns();

            // Init Firebase and Auth Listener
            initializeAppFirebase();

            // Setup global listeners (moved from end to ensure they are active early)
            setupGlobalEventListeners();
        });

        // Populate only the static dropdowns (Subject, Session)
        function populateSubjectAndSessionDropdowns() {
            // ... (code unchanged)
             const subjectOptionsContainer = document.getElementById('add-topic-modal-subject-options');
             subjectOptionsContainer.innerHTML = '';
             columnHeaders.table1.forEach((subject, index) => {
                 const option = document.createElement('div');
                 option.className = 'custom-dropdown-option';
                 if (index === 0) option.classList.add('selected');
                 option.dataset.value = subject;
                 option.textContent = subject;
                 subjectOptionsContainer.appendChild(option);
             });
            if (columnHeaders.table1.length > 0 && addSubjectInput) addSubjectInput.value = columnHeaders.table1[0];

             const sessionOptionsContainer = document.getElementById('add-topic-modal-session-options');
             sessionOptionsContainer.innerHTML = '';
             columnHeaders.table2.forEach((session, index) => {
                 const option = document.createElement('div');
                 option.className = 'custom-dropdown-option';
                 if (index === 0) option.classList.add('selected');
                 option.dataset.value = session;
                 option.textContent = session;
                 sessionOptionsContainer.appendChild(option);
             });
            if (columnHeaders.table2.length > 0 && addSessionInput) addSessionInput.value = columnHeaders.table2[0];
        }

        // ========================================================================
        // FIREBASE & AUTHENTICATION
        // ========================================================================

        async function initializeAppFirebase() {
            try {
                let firebaseConfig;
                // --- Keep existing Firebase config logic ---
                 if (typeof __firebase_config !== 'undefined') {
                    try { firebaseConfig = JSON.parse(__firebase_config); } catch (e) { firebaseConfig = null; }
                   }
                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    firebaseConfig = { // Keep your default fallback config
                        apiKey: "AIzaSyBWvyaFWIL0PV4VD33BJNQl3qP2k1IbQus", authDomain: "rutine-f2ac1.firebaseapp.com",
                        projectId: "rutine-f2ac1", storageBucket: "rutine-f2ac1.appspot.com",
                        messagingSenderId: "161382347749", appId: "1:161382347749:web:a07ebafa5bdd35d480350c"
                     };
                   }
                // --- End of Firebase config logic ---

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                try { await enableIndexedDbPersistence(db); } catch (err) { console.warn("Offline persistence failed:", err.code); }

                setupAuthStateListener();

            } catch (error) {
                console.error("Firebase Init Error:", error);
                googleLoginError.textContent = "Firebase init failed. Check config.";
                googleLoginError.classList.remove('hidden');
            }
        }

        function setupAuthStateListener() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is SIGNED IN
                    currentUserId = user.uid;
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                    // Set user-specific doc paths
                    const dataPath = `artifacts/${appId}/users/${currentUserId}/studyProgress/data_v4`;
                    const settingsPath = `artifacts/${appId}/users/${currentUserId}/studyProgress/settings_v1`;
                    dbDocRef = doc(db, dataPath);
                    settingsDocRef = doc(db, settingsPath);

                    // Update settings modal UI
                    settingsUserImg.src = user.photoURL || 'data:image/svg+xml;base64,...'; // Placeholder SVG
                    settingsUserName.textContent = user.displayName || 'App User';
                    settingsUserEmail.textContent = user.email || 'No email provided';

                    // Start loading settings
                    settingsLoaded = false; // Reset flag
                    loadSettingsFromFirestore(); // This will eventually trigger loadDataFromFirestore

                    // Hide login, show loading
                    loginScreen.classList.add('hidden'); // Use hidden class
                    mainAppContainer.classList.remove('hidden');
                    loadingEl.classList.remove('hidden'); // Show "Loading Dashboard..."
                    contentEl.classList.add('hidden'); // Hide content until data loads

                } else {
                    // User is SIGNED OUT
                    currentUserId = null;
                    cleanupListenersAndState(); // Clear all data

                    // Show login, hide app
                    loginScreen.classList.remove('hidden'); // Use hidden class
                    mainAppContainer.classList.add('hidden');
                    loadingEl.classList.add('hidden');
                    googleLoginError.classList.add('hidden');
                    googleLoginText.textContent = 'Sign In with Google';
                    googleLoginBtn.disabled = false;
                }
            });
        }

        async function handleGoogleSignIn() {
            // ... (code unchanged)
             googleLoginBtn.disabled = true;
             googleLoginText.textContent = 'Signing in...';
             googleLoginSpinner.classList.remove('hidden');
             googleLoginError.classList.add('hidden');

             const provider = new GoogleAuthProvider();
             try {
                 await signInWithPopup(auth, provider);
                 // Auth listener (onAuthStateChanged) will handle the rest
             } catch (error) {
                 console.error("Google Sign-In Error:", error);
                 googleLoginError.textContent = `Error: ${error.message}`;
                 googleLoginError.classList.remove('hidden');
                 googleLoginBtn.disabled = false;
                 googleLoginText.textContent = 'Sign In with Google';
                 googleLoginSpinner.classList.add('hidden');
             }
        }

        async function handleSignOut() {
            // ... (code unchanged)
             try {
                 await signOut(auth);
                 // Auth listener will handle cleanup
                 closeModal(settingsModalEl);
             } catch (error) {
                 console.error("Sign Out Error:", error);
                 showToastQueued('error', 'Sign out failed.');
             }
        }

        // Cleanup listeners and state on logout
        function cleanupListenersAndState() {
            if (unsubscribeSnapshot) { unsubscribeSnapshot(); unsubscribeSnapshot = null; }
            if (unsubscribeSettings) { unsubscribeSettings(); unsubscribeSettings = null; }
            if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
            if (saveTimeout) { clearTimeout(saveTimeout); saveTimeout = null; }
            if (toastTimeout) { clearTimeout(toastTimeout); toastTimeout = null; }
            if (calendarClickTimer) { clearTimeout(calendarClickTimer); calendarClickTimer = null; } // Bug 12 Fix

            appData = { completedTopics: {} };
            tableData = { table1: {}, table2: {} };
            // Reset settings to default
            appSettings.customStudyTypes = JSON.parse(JSON.stringify(DEFAULT_STUDY_TYPES));
            appSettings.countdownName = DEFAULT_COUNTDOWN_NAME;
            appSettings.countdownDate = DEFAULT_COUNTDOWN_DATE;
            appSettings.countdownMaxDays = 365;

            table1CardsContainer.innerHTML = '';
            table2CardsContainer.innerHTML = '';
            updateAllProgressUI(); // Reset progress bars to 0%
            startCountdown(); // Reset countdown display to defaults

            toastQueue.length = 0; // Bug 10 Fix
            isToastShowing = false; // Reset toast state
            settingsLoaded = false; // Reset settings load flag

            console.log("State and listeners cleaned up.");
        }


        // ========================================================================
        // SETTINGS & CUSTOMIZATION LOGIC
        // ========================================================================

        function loadSettingsFromFirestore() {
            if (!settingsDocRef) return;
            if (unsubscribeSettings) unsubscribeSettings();

            unsubscribeSettings = onSnapshot(settingsDocRef, (doc) => {
                let needsSave = false;
                if (doc.exists()) {
                    const settings = doc.data();
                    // Load Study Types
                    if (settings.customStudyTypes && Array.isArray(settings.customStudyTypes)) {
                        appSettings.customStudyTypes = settings.customStudyTypes;
                    } else {
                        appSettings.customStudyTypes = JSON.parse(JSON.stringify(DEFAULT_STUDY_TYPES));
                        needsSave = true; // Save defaults if missing
                    }
                    // Load Countdown Settings
                    appSettings.countdownName = settings.countdownName || DEFAULT_COUNTDOWN_NAME;
                    appSettings.countdownDate = settings.countdownDate || DEFAULT_COUNTDOWN_DATE;
                    // Recalculate maxDays based on loaded date
                    calculateCountdownMaxDays();
                    appSettings.countdownMaxDays = settings.countdownMaxDays || calculateCountdownMaxDays(); // Store calculated max days if missing

                } else {
                    // No settings doc. This is a new user or first load. Use defaults.
                    appSettings.customStudyTypes = JSON.parse(JSON.stringify(DEFAULT_STUDY_TYPES));
                    appSettings.countdownName = DEFAULT_COUNTDOWN_NAME;
                    appSettings.countdownDate = DEFAULT_COUNTDOWN_DATE;
                    appSettings.countdownMaxDays = calculateCountdownMaxDays();
                    needsSave = true; // Save defaults
                }

                settingsLoaded = true; // Mark settings as loaded
                populateAllStudyTypeDropdowns(); // Bug 5 Fix: Populate dropdowns now
                startCountdown(); // Update countdown with loaded/default settings

                // Bug 3 Fix: Load data *after* settings are processed
                if (!unsubscribeSnapshot) { // Only load data if not already listening
                   loadDataFromFirestore();
                } else {
                   // If data listener already exists, re-render in case study types changed display
                   if (!isFirstLoad) renderData();
                }


                if (needsSave) {
                    saveSettingsToFirestore(); // Save defaults if needed
                }
            }, (error) => {
                console.error("Error loading settings:", error);
                showToastQueued('error', 'Failed to load settings.');
                // Handle error state - maybe load defaults and allow app usage?
                settingsLoaded = true; // Mark as loaded even on error to potentially proceed
                appSettings.customStudyTypes = JSON.parse(JSON.stringify(DEFAULT_STUDY_TYPES)); // Use defaults on error
                appSettings.countdownName = DEFAULT_COUNTDOWN_NAME;
                appSettings.countdownDate = DEFAULT_COUNTDOWN_DATE;
                appSettings.countdownMaxDays = calculateCountdownMaxDays();
                populateAllStudyTypeDropdowns();
                startCountdown();
                if (!unsubscribeSnapshot) loadDataFromFirestore(); // Try loading data even if settings failed
            });
        }

        // Calculate initial max days for the circle animation base
        function calculateCountdownMaxDays() {
            try {
                const targetTime = new Date(appSettings.countdownDate + "T00:00:00").getTime();
                const now = new Date().getTime();
                const diff = targetTime - now;
                return diff > 0 ? Math.ceil(diff / 864e5) : 1; // Return at least 1 day
            } catch (e) {
                return 365; // Fallback
            }
        }


        async function saveSettingsToFirestore() {
            if (!settingsDocRef) return;
            try {
                showToastQueued('syncing', 'Saving settings...');
                // Ensure countdownMaxDays is calculated based on the date being saved
                appSettings.countdownMaxDays = calculateCountdownMaxDays();
                await setDoc(settingsDocRef, {
                    customStudyTypes: appSettings.customStudyTypes,
                    countdownName: appSettings.countdownName,
                    countdownDate: appSettings.countdownDate,
                    countdownMaxDays: appSettings.countdownMaxDays // Save calculated max days
                }, { merge: true }); // Merge true to avoid overwriting unrelated fields if any
                showToastQueued('synced', 'Settings saved!');
            } catch (error) {
                console.error("Error saving settings:", error);
                showToastQueued('error', 'Failed to save settings.');
            }
        }

        // Renders the "Customizations" tab in the Settings modal
        function renderSettingsModal() {
            // Populate Study Types
            customStudyTypeList.innerHTML = '';
            if (!appSettings.customStudyTypes || appSettings.customStudyTypes.length === 0) {
                customStudyTypeList.innerHTML = `<p class="text-slate-400">No study types found. Add one!</p>`;
            } else {
                 appSettings.customStudyTypes.forEach(studyType => {
                     const itemEl = document.createElement('div');
                     itemEl.className = 'custom-study-type-item';
                     itemEl.dataset.key = studyType.key;
                     itemEl.innerHTML = `
                        <input type="text" class="custom-study-type-name settings-input" value="${studyType.name}" placeholder="Study Type Name">
                        <button type="button" class="delete-btn" title="Delete Study Type">
                             <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>`;
                     customStudyTypeList.appendChild(itemEl);
                 });
             }

            // Populate Countdown Settings
            settingsCountdownNameInput.value = appSettings.countdownName || '';
            settingsCountdownDateInput.value = appSettings.countdownDate || '';
        }

        function handleSettingsAddStudyType() {
            // ... (code unchanged)
             const newKey = `custom_${Date.now()}`;
             const newName = "New Study Type";
             appSettings.customStudyTypes.push({ key: newKey, name: newName });
             renderSettingsModal(); // Re-render the list
             const newItemEl = customStudyTypeList.querySelector(`[data-key="${newKey}"] input`);
             if (newItemEl) { newItemEl.focus(); newItemEl.select(); }
        }

        function handleSettingsDeleteStudyType(button) {
            // ... (code unchanged)
             const itemEl = button.closest('.custom-study-type-item');
             if (!itemEl) return;
             const keyToDelete = itemEl.dataset.key;
             const isInUse = Object.values(appData.completedTopics).some(topic => topic.studyStatus === keyToDelete);
             if (isInUse) { showToastQueued('error', 'Cannot delete a study type that is in use.'); return; }
             appSettings.customStudyTypes = appSettings.customStudyTypes.filter(type => type.key !== keyToDelete);
             itemEl.remove(); // Remove directly from DOM for immediate feedback
             showToastQueued('info', 'Study type removed. Click Save.');
        }

        async function handleSettingsSave() {
            // --- Save Study Types ---
            const newStudyTypes = [];
            const studyTypeItems = customStudyTypeList.querySelectorAll('.custom-study-type-item');
            let studyTypeError = false;
            studyTypeItems.forEach(item => {
                const key = item.dataset.key;
                const input = item.querySelector('.custom-study-type-name');
                const name = input.value.trim();
                if (!name) { input.style.borderColor = 'var(--color-accent-red)'; studyTypeError = true; }
                else { input.style.borderColor = 'var(--color-border)'; }
                newStudyTypes.push({ key, name });
            });
            if (studyTypeError) { showToastQueued('error', 'Study type names cannot be empty.'); return; }
            appSettings.customStudyTypes = newStudyTypes;

            // --- Save Countdown Settings ---
            const newCountdownName = settingsCountdownNameInput.value.trim();
            const newCountdownDate = settingsCountdownDateInput.value;
            let dateError = false;
            if (!newCountdownName) {
                settingsCountdownNameInput.style.borderColor = 'var(--color-accent-red)';
                dateError = true;
            } else {
                 settingsCountdownNameInput.style.borderColor = 'var(--color-border)';
             }
             if (!newCountdownDate) {
                 settingsCountdownDateInput.style.borderColor = 'var(--color-accent-red)';
                 dateError = true;
            } else {
                 // Basic validation if date is in the past
                 try {
                     const targetDate = new Date(newCountdownDate + "T00:00:00");
                     const nowDate = new Date();
                     nowDate.setHours(0,0,0,0); // Compare dates only
                     if (targetDate < nowDate) {
                        settingsCountdownDateInput.style.borderColor = 'var(--color-accent-yellow)'; // Warning color
                        showToastQueued('error', 'Warning: Target date is in the past.');
                        // Allow saving past dates if user insists
                    } else {
                         settingsCountdownDateInput.style.borderColor = 'var(--color-border)';
                    }
                 } catch(e) {
                     settingsCountdownDateInput.style.borderColor = 'var(--color-accent-red)';
                     dateError = true;
                 }
            }
             if (dateError) { showToastQueued('error', 'Countdown name and date are required.'); return; }

             appSettings.countdownName = newCountdownName;
             appSettings.countdownDate = newCountdownDate;
             appSettings.countdownMaxDays = calculateCountdownMaxDays(); // Recalculate max days

            // --- Save All Settings ---
            await saveSettingsToFirestore();
            populateAllStudyTypeDropdowns(); // Re-populate dropdowns
            startCountdown(); // Update countdown display immediately
            closeModal(settingsModalEl);
        }

        // Populates ALL study type dropdowns (Add, Edit) from appSettings
        function populateAllStudyTypeDropdowns() {
            const containers = [
                document.getElementById('add-topic-modal-study-options'),
                document.getElementById('modal-topic-study-options')
            ];
            const defaultKey = (appSettings.customStudyTypes && appSettings.customStudyTypes.length > 0) ? appSettings.customStudyTypes[0].key : '';

            containers.forEach(container => {
                if (!container) return;
                const currentVal = container.closest('.custom-dropdown')?.querySelector('input[type="hidden"]')?.value; // Preserve current selection if possible
                container.innerHTML = ''; // Clear old options

                if (!appSettings.customStudyTypes || appSettings.customStudyTypes.length === 0) {
                     // Add a placeholder or disable if no types exist? For now, leave empty.
                } else {
                     appSettings.customStudyTypes.forEach((type) => {
                         const option = document.createElement('div');
                         option.className = 'custom-dropdown-option';
                         // Don't auto-select first, let setDropdownValue handle it
                         option.dataset.value = type.key;
                         option.textContent = type.name;
                         container.appendChild(option);
                     });
                 }

                // Reset the parent dropdown, trying to keep selection or using default
                const dropdown = container.closest('.custom-dropdown');
                if (dropdown) {
                    const valueToSet = appSettings.customStudyTypes.some(t => t.key === currentVal) ? currentVal : defaultKey;
                    setDropdownValue(dropdown, valueToSet);
                }
            });
        }

        // Helper to get display name from key
        function getStudyTypeName(key) {
            const found = appSettings.customStudyTypes.find(type => type.key === key);
            return found ? found.name : key; // Fallback to key
        }
        // Helper to get style class from key
        function getStudyTypeClass(key) {
            const defaultClasses = ['mqb', 'ret', 'med', 'camp', 'week', 'rev', 'new', 'secret'];
            if (defaultClasses.includes(key)) return `study-${key}`;
            return 'study-custom'; // Generic class
        }

        // ========================================================================
        // DATA LOGIC
        // ========================================================================

        function loadDataFromFirestore() {
            if (!dbDocRef || !settingsLoaded) { // Bug 3 Fix: Wait for settings
                console.warn("Attempted to load data before settings or docRef ready.");
                 // Optionally set a timeout to retry?
                if (!settingsLoaded) {
                     setTimeout(loadDataFromFirestore, 200); // Retry if settings were slow
                 }
                return;
             }
            if (unsubscribeSnapshot) unsubscribeSnapshot(); // Unsubscribe from old listener

            showToastQueued('syncing');

            unsubscribeSnapshot = onSnapshot(dbDocRef, (doc) => {
                pendingChanges = false; // Reset pending changes on new snapshot
                if (doc.exists()) {
                    const data = doc.data();
                    let loadedTableData = data.tableData ? JSON.parse(JSON.stringify(data.tableData)) : null;
                    if (isOldDataStructure(loadedTableData)) {
                        console.warn("Old data structure detected...");
                        showToastQueued('error', 'Old data incompatible. Resetting...');
                        tableData = JSON.parse(JSON.stringify(DEFAULT_TABLE_DATA));
                        appData.completedTopics = {};
                        pendingChanges = true;
                    } else if (loadedTableData) {
                        tableData = loadedTableData;
                        appData.completedTopics = data.completedTopics || {};
                    } else { // Doc exists but no tableData
                        tableData = JSON.parse(JSON.stringify(DEFAULT_TABLE_DATA));
                        appData.completedTopics = {};
                        pendingChanges = true;
                    }
                } else { // No data doc exists
                    tableData = JSON.parse(JSON.stringify(DEFAULT_TABLE_DATA));
                    appData.completedTopics = {};
                    pendingChanges = true; // Need to save the default structure
                }

                // Clean orphaned IDs (ensure topics exist)
                Object.keys(tableData).forEach(tableId => {
                     if (!tableData[tableId]) tableData[tableId] = {};
                     Object.keys(tableData[tableId]).forEach(date => {
                         if (!tableData[tableId][date]) tableData[tableId][date] = {};
                         Object.keys(tableData[tableId][date]).forEach(colName => {
                             if (Array.isArray(tableData[tableId][date][colName])) {
                                 const originalLength = tableData[tableId][date][colName].length;
                                 tableData[tableId][date][colName] = tableData[tableId][date][colName].filter(
                                     topicId => appData.completedTopics[topicId] // Check if topic exists in completedTopics
                                 );
                                 if (tableData[tableId][date][colName].length !== originalLength) {
                                     pendingChanges = true; // Mark for saving if orphans were removed
                                 }
                             } else {
                                 // Ensure it's always an array
                                 tableData[tableId][date][colName] = [];
                                 pendingChanges = true;
                             }
                         });
                     });
                 });

                runExamMigration();
                if (pendingChanges) {
                    saveDataToFirestore(); // Save immediately if structure needed fixing
                }

                renderData(); // Render the potentially updated data
                showToastQueued(doc.metadata.fromCache ? "cached" : "synced");
            }, (error) => {
                console.error("Firestore data snapshot error:", error);
                loadingEl.innerHTML = `<p class="text-red-400">Error: Load failed.</p>`;
                contentEl.classList.add('hidden'); // Hide content on error
                showToastQueued('error', 'Data load failed');
            });
        }

        function saveDataToFirestore() {
            // ... (code unchanged, just ensure pendingChanges logic is correct)
             if (!dbDocRef || !currentUserId) return;
             // Don't reset pendingChanges here, let the timeout handle it
             if (saveTimeout) clearTimeout(saveTimeout);

             const topicsToSave = JSON.parse(JSON.stringify(appData.completedTopics));
             const tableDataToSave = JSON.parse(JSON.stringify(tableData));

             saveTimeout = setTimeout(async () => {
                 pendingChanges = false; // Assume save will succeed unless error
                 try {
                     showToastQueued('syncing');
                     await setDoc(dbDocRef, {
                         completedTopics: topicsToSave,
                         tableData: tableDataToSave
                     }, { merge: false }); // Use merge: false to overwrite completely
                     showToastQueued('synced');
                 } catch (error) {
                     console.error("Firestore save error:", error);
                     showToastQueued('error', 'Sync Error');
                     pendingChanges = true; // Re-mark as pending if save failed
                 }
             }, 1000); // Debounce saves
        }

        function isOldDataStructure(data) { /* ... (code unchanged) ... */ return false; } // Simplified for now
        function runExamMigration() { /* ... (code unchanged) ... */ }

        // ========================================================================
        // UI & RENDERING LOGIC
        // ========================================================================

        function renderData() {
            if (!settingsLoaded) return; // Don't render if settings aren't loaded yet
            renderAllCards();
            updateAllProgressUI();
            updateViewToggleUI();
            loadingEl.classList.add('hidden');
            contentEl.classList.remove('hidden');
            isFirstLoad = false;
        }

        function renderAllCards() {
            // ... (code unchanged)
            table1CardsContainer.innerHTML = '';
            table2CardsContainer.innerHTML = '';
            if (!tableData.table1) tableData.table1 = {};
            if (!tableData.table2) tableData.table2 = {};

            Object.keys(tableData).forEach(tableId => {
                const container = tableId === 'table1' ? table1CardsContainer : table2CardsContainer;
                const data = tableData[tableId];
                if (!container || !data) return;

                const dates = Object.keys(data);
                const sortedDates = dates.sort((a, b) => { /* ... sort logic ... */
                    try { const dateAStr = a; const dateBStr = b; if (dateAStr === 'New Date') return 1; if (dateBStr === 'New Date') return -1; const dateA = new Date(dateAStr.split('/').reverse().join('-')); const dateB = new Date(dateBStr.split('/').reverse().join('-')); return dateA - dateB; } catch (e) { return 0; }
                 });

                sortedDates.forEach(date => {
                    const cardData = data[date] || {};
                    const card = createDateCard(tableId, date, cardData);
                    container.appendChild(card);
                });
            });

            updateAllCardProgressBars();
        }

        function createDateCard(tableId, date, dateData) {
            // ... (code largely unchanged, check IDs for progress bars)
             const card = document.createElement('div');
             card.className = 'date-card';
             card.dataset.tableId = tableId;
             card.dataset.date = date;

             const cardHeader = document.createElement('div');
             cardHeader.className = 'date-header';

             const dateDiv = document.createElement('div');
             dateDiv.className = 'date-header-text';
             dateDiv.textContent = date;
             dateDiv.contentEditable = "true";
             dateDiv.dataset.originalDate = date;
             dateDiv.dataset.label = "Date";
             dateDiv.setAttribute('placeholder', 'DD/MM/YYYY');
             cardHeader.appendChild(dateDiv);

             const dateId = date.replace(/[\/ ]/g, '-'); // Ensure IDs are valid
             const progressContainer = document.createElement('div');
             progressContainer.className = 'card-progress-container';
             // Ensure IDs are valid using dateId
             progressContainer.innerHTML = `<div class="card-progress-text" id="card-progress-text-${tableId}-${dateId}">0%</div><div class="card-progress-bar-bg"><div class="card-progress-bar-fg" id="card-progress-bar-${tableId}-${dateId}" style="width:0%;"></div></div><div class="card-progress-count" id="card-progress-count-${tableId}-${dateId}">0 / 0 Done</div>`;
             cardHeader.appendChild(progressContainer);
             cardHeader.appendChild(createDeleteRowButton(card));

             card.appendChild(cardHeader);

             const headers = columnHeaders[tableId];
             headers.forEach(colName => {
                 const topicIdArray = dateData[colName];
                 const section = document.createElement('div');
                 section.className = 'column-section';
                 section.dataset.colName = colName;
                 section.innerHTML = `<span class="column-title">${colName}</span>`;
                 if (Array.isArray(topicIdArray)) {
                     topicIdArray.forEach(topicId => {
                         if (typeof topicId === 'string') {
                             const topicEl = createTopicElement(topicId);
                             if (topicEl) section.appendChild(topicEl);
                         }
                     });
                 }
                 card.appendChild(section);
             });

             const cardFooter = document.createElement('div');
             cardFooter.className = 'card-footer';
             const addBtn = document.createElement('button');
             addBtn.type = 'button';
             addBtn.className = 'add-topic-btn-card-single';
             addBtn.textContent = '+ Add New Topic';
             cardFooter.appendChild(addBtn);
             card.appendChild(cardFooter);

            return card;
        }

        function createTopicElement(topicId) {
             const topicData = appData.completedTopics[topicId];
             if (!topicData) { console.warn("Orphaned topic ID:", topicId); return null; }

             const progress = topicData.progress || 0;
             const note = topicData.note || '';
             const timedNote = topicData.timedNote || '';
             const displayName = topicData.name || 'Unnamed Topic';
             const priority = topicData.priority || 'low';
             // Bug 1 Fix: Fallback for studyStatus if custom types are empty or key is invalid
             const defaultStudyKey = (appSettings.customStudyTypes && appSettings.customStudyTypes.length > 0) ? appSettings.customStudyTypes[0].key : 'new';
             const studyStatusKey = topicData.studyStatus && appSettings.customStudyTypes.some(t => t.key === topicData.studyStatus) ? topicData.studyStatus : defaultStudyKey;
             const hardness = topicData.hardness || 'medium';

             const topicEl = document.createElement('div');
             topicEl.className = 'topic-item';
             topicEl.draggable = true;
             topicEl.dataset.topicId = topicId;

             const priorityIndicator = document.createElement('span');
             priorityIndicator.className = `priority-indicator priority-${priority}`;
             priorityIndicator.title = `Priority: ${priority}`;
             topicEl.appendChild(priorityIndicator);

             const progressBox = document.createElement('div');
             progressBox.className = `progress-box progress-${progress}`;
             progressBox.innerHTML = `<span>${progress}%</span>`;
             progressBox.dataset.topicId = topicId;

             const nameContainer = document.createElement('div');
             nameContainer.className = 'topic-name-container';
             const nameEl = document.createElement('span');
             nameEl.className = 'topic-name';
             nameEl.dataset.topicName = displayName;

             const nameText = document.createElement('span');
             nameText.className = 'topic-name-text';
             nameText.textContent = displayName + ' '; // Add space
             nameEl.appendChild(nameText);

             const hardnessTag = document.createElement('span');
             hardnessTag.className = `study-status study-${hardness}`;
             hardnessTag.textContent = hardnessMap[hardness] || 'M';
             hardnessTag.title = `Hardness: ${hardness}`;
             nameEl.appendChild(hardnessTag);

             // Dynamic Study Type
             const statusTag = document.createElement('span');
             const studyTypeName = getStudyTypeName(studyStatusKey);
             statusTag.className = `study-status ${getStudyTypeClass(studyStatusKey)}`;
             // Bug 8 Fix: Smart truncate
             statusTag.textContent = studyTypeName.length > 6 ? studyTypeName.substring(0, 5) + '' : studyTypeName;
             statusTag.title = studyTypeName;
             nameEl.appendChild(statusTag);

             nameContainer.appendChild(nameEl);

             if (timedNote) {
                 const timedNoteEl = document.createElement('span');
                 timedNoteEl.className = 'timed-note-display';
                 timedNoteEl.textContent = timedNote;
                 nameContainer.appendChild(timedNoteEl);
             }

             const editIcon = document.createElement('button');
             editIcon.type = 'button';
             editIcon.className = 'edit-icon';
             if (note) editIcon.classList.add('has-note');
             editIcon.dataset.topicId = topicId;
             editIcon.title = note ? 'Edit Note...' : 'Add Note...';
             editIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`; // Slightly smaller icon

             topicEl.appendChild(progressBox);
             topicEl.appendChild(nameContainer);
             topicEl.appendChild(editIcon);

            return topicEl;
        }


        function createDeleteRowButton(cardElement) { /* ... (code unchanged) ... */
             const deleteBtn = document.createElement('button'); deleteBtn.type = 'button'; deleteBtn.className = 'delete-row-btn'; deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`; deleteBtn.title = 'Delete Date Card'; return deleteBtn;
        }
        function createTopicId() { /* ... (code unchanged) ... */ return 'topic_' + Date.now().toString(36) + Math.random().toString(36).substring(2, 9); }
        function showConfirmationModal(message, onConfirm, confirmText = "Yes, Delete", buttonClass = "button-danger") { /* ... (code unchanged) ... */
             confirmMessageEl.textContent = message; confirmCallback = onConfirm; const confirmBtn = document.getElementById('confirm-yes'); confirmBtn.textContent = confirmText; confirmBtn.className = `modern-button ${buttonClass}`; openModal(confirmModalEl);
        }
        function getFormattedDate(date) { /* ... (code unchanged) ... */ const d = String(date.getDate()).padStart(2, '0'); const m = String(date.getMonth() + 1).padStart(2, '0'); const y = date.getFullYear(); return `${d}/${m}/${y}`; }
        function sortCardsInContainer(container) { /* ... (code unchanged) ... */
             const cards = Array.from(container.children); cards.sort((a, b) => { try { const dateAStr = a.dataset.date; const dateBStr = b.dataset.date; if (dateAStr === 'New Date') return 1; if (dateBStr === 'New Date') return -1; const dateA = new Date(dateAStr.split('/').reverse().join('-')); const dateB = new Date(dateBStr.split('/').reverse().join('-')); return dateA - dateB; } catch (e) { return 0; } }); cards.forEach(c => container.appendChild(c));
        }

        // ========================================================================
        // GLOBAL EVENT HANDLERS
        // ========================================================================

        function setupGlobalEventListeners() {
            // ... (keep existing listeners, adjust settings tab logic)
             const container = document.body;

             // Login/Logout
             googleLoginBtn.addEventListener('click', handleGoogleSignIn);
             googleSignoutBtn.addEventListener('click', handleSignOut);

             // Settings Modal & Tabs
             settingsBtn.addEventListener('click', () => {
                 renderSettingsModal(); // Populate with current settings
                 openModal(settingsModalEl);
             });
            // New Tab Button Listeners
            document.querySelectorAll('.settings-nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.dataset.tab;
                    // Update button active states
                    document.querySelectorAll('.settings-nav-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    // Update tab content visibility
                    document.querySelectorAll('.settings-tab-content').forEach(tab => {
                        tab.classList.toggle('hidden', tab.id !== `settings-tab-${tabId}`);
                    });
                });
            });

             settingsAddStudyTypeBtn.addEventListener('click', handleSettingsAddStudyType);
             settingsSaveBtn.addEventListener('click', handleSettingsSave);
             settingsCancelBtn.addEventListener('click', () => closeModal(settingsModalEl));
             customStudyTypeList.addEventListener('click', (e) => {
                 if (e.target.closest('.delete-btn')) {
                     handleSettingsDeleteStudyType(e.target.closest('.delete-btn'));
                 }
             });
            settingsModalEl.addEventListener('click', (e) => { // Close on backdrop click
                if (e.target === settingsModalEl) closeModal(settingsModalEl);
            });


             // Calendar Nav Button (Single/Double Click)
             calendarNavBtn.addEventListener('click', () => { /* ... (unchanged) ... */
                if (calendarClickTimer) { clearTimeout(calendarClickTimer); calendarClickTimer = null; handleOpenCalendar(); } else { calendarClickTimer = setTimeout(() => { handleGoToToday(); calendarClickTimer = null; }, 250); }
             });

             // General Clicks (Delegated)
             container.addEventListener('click', (e) => { /* ... (most logic unchanged) ... */
                const target = e.target;
                const closestTarget = (selector) => target.closest(selector);

                // Close dropdowns if clicking outside
                if (!closestTarget('.custom-dropdown')) { closeAllDropdowns(); }

                const dropdownButton = closestTarget('.custom-dropdown-button');
                if (dropdownButton) { toggleDropdown(dropdownButton.closest('.custom-dropdown')); return; }

                const dropdownOption = closestTarget('.custom-dropdown-option');
                if (dropdownOption) { selectDropdownOption(dropdownOption); return; }

                // View Toggles
                if (target.id === 'view-toggle-table1' || target.id === 'view-toggle-table2') { handleViewToggle(target.dataset.view); return; }

                // Topic Interactions
                const progressBox = closestTarget('.progress-box');
                if (progressBox) { handleProgressClick(progressBox, false); return; }
                if (closestTarget('.edit-icon')) { handleEditClick(closestTarget('.edit-icon')); return; }

                // Card/Row Actions
                if (target.classList.contains('add-topic-btn-card-single')) { handleAddTopicClick(target); return; }
                if (target.id === 'add-row-t1') { addNewRow('table1'); return; }
                if (target.id === 'add-row-t2') { addNewRow('table2'); return; }
                if (target.id === 'open-calendar-btn') { handleOpenCalendar(); return; }
                if (closestTarget('.delete-row-btn')) { handleDeleteRowClick(closestTarget('.delete-row-btn')); return; }

                // Modals
                if (target.id === 'modal-save') { handleModalSave(); return; }
                if (target.id === 'modal-cancel' || (closestTarget('#edit-modal') && target === modalEl)) { closeModal(modalEl); return; }
                if (target.id === 'modal-delete') { handleModalDelete(); return; }

                if (closestTarget('.priority-btn')) { /* ... (priority unchanged) ... */
                    const btn = closestTarget('.priority-btn'); const selector = btn.closest('#modal-priority-selector, #add-topic-priority-selector'); if (selector) { selector.querySelectorAll('.priority-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); } return;
                 }

                if (target.id === 'add-topic-modal-save') { handleModalAddSave(); return; }
                if (target.id === 'add-topic-modal-cancel' || (closestTarget('#add-topic-modal') && target === addTopicModalEl)) { closeModal(addTopicModalEl); return; }

                // Confirmation Modal
                if (target.id === 'confirm-yes') { if (typeof confirmCallback === 'function') { confirmCallback(); } confirmCallback = null; closeModal(confirmModalEl); return; }
                if (target.id === 'confirm-cancel' || target === confirmModalEl) { confirmCallback = null; closeModal(confirmModalEl); return; }

                 // Calendar Interactions
                 if (target.id === 'calendar-prev-month' || closestTarget('#calendar-prev-month')) { calendarState.month--; if (calendarState.month < 0) { calendarState.month = 11; calendarState.year--; } renderCalendar(calendarState.month, calendarState.year); return; }
                 if (target.id === 'calendar-next-month' || closestTarget('#calendar-next-month')) { calendarState.month++; if (calendarState.month > 11) { calendarState.month = 0; calendarState.year++; } renderCalendar(calendarState.month, calendarState.year); return; }
                 if (closestTarget('.calendar-day') && !target.closest('.calendar-day').classList.contains('empty') && !target.closest('.calendar-day').classList.contains('disabled')) { handleCalendarDateClick(closestTarget('.calendar-day')); return; }
                 if (target.id === 'calendar-cancel' || (closestTarget('#calendar-modal') && target === calendarModalEl)) { closeModal(calendarModalEl); return; }

                 // Close Modals on Backdrop Click (except confirm)
                 if (target === addTopicModalEl) { closeModal(addTopicModalEl); return; }
                 if (target === modalEl) { closeModal(modalEl); return; }
                 if (target === calendarModalEl) { closeModal(calendarModalEl); return; }
                 // Settings modal already handled above
             });

            // Right-click for progress decrement
            container.addEventListener('contextmenu', (e) => { /* ... (unchanged) ... */ if (e.target.closest('.progress-box')) { e.preventDefault(); handleProgressClick(e.target.closest('.progress-box'), true); } });

            // Date Editing Focus/Blur
            container.addEventListener('focusin', (e) => { /* ... (unchanged) ... */ if (e.target.contentEditable === 'true' && e.target.dataset.label === 'Date') { e.target.dataset.originalDate = e.target.textContent.trim(); } });
            container.addEventListener('blur', (e) => { /* ... (unchanged) ... */ if (e.target.contentEditable === 'true' && e.target.dataset.label === 'Date') { handleDateChange(e.target); } }, true);

            // Drag and Drop
            let draggedElement = null;
            container.addEventListener('dragstart', (e) => { /* ... (unchanged) ... */ if (e.target.classList.contains('topic-item')) { draggedElement = e.target; setTimeout(() => { e.target.classList.add('dragging'); }, 0); } });
            container.addEventListener('dragend', (e) => { /* ... (unchanged) ... */ if (draggedElement) draggedElement.classList.remove('dragging'); draggedElement = null; document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); });
            container.addEventListener('dragenter', (e) => { /* ... (unchanged) ... */ const section = e.target.closest('.column-section'); if (section && draggedElement) { document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); section.classList.add('drag-over'); } });
            container.addEventListener('drop', (e) => { /* ... (unchanged) ... */ e.preventDefault(); const section = e.target.closest('.column-section'); document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); if (section && draggedElement) handleDragDrop(draggedElement, section); });

            // Keyboard Shortcuts
            document.addEventListener('keydown', (e) => { /* ... (logic mostly unchanged, ensure checks for ALL modals) ... */
                 if (!currentUserId) return; // Only if logged in
                 const target = e.target;
                 if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.contentEditable === 'true') { if (target.contentEditable === 'true' && target.dataset.label === 'Date' && e.key === 'Enter') { e.preventDefault(); target.blur(); } return; }
                 // Check ALL potentially open modals
                 const isModalOpen = modalEl.classList.contains('show') || addTopicModalEl.classList.contains('show') || confirmModalEl.classList.contains('show') || calendarModalEl.classList.contains('show') || settingsModalEl.classList.contains('show');
                 if (isModalOpen) { if (e.key === 'Escape') { if (modalEl.classList.contains('show')) closeModal(modalEl); else if (addTopicModalEl.classList.contains('show')) closeModal(addTopicModalEl); else if (confirmModalEl.classList.contains('show')) { confirmCallback = null; closeModal(confirmModalEl); } else if (calendarModalEl.classList.contains('show')) closeModal(calendarModalEl); else if (settingsModalEl.classList.contains('show')) closeModal(settingsModalEl); } if (addTopicModalEl.classList.contains('show') && e.key === 'Enter') { e.preventDefault(); handleModalAddSave(); } return; } // Prevent other shortcuts if modal open
                 if (e.key === 'n') { /* ... (add topic 'n' shortcut unchanged) ... */ e.preventDefault(); const currentCardsContainer = currentView === 'table1' ? table1CardsContainer : table2CardsContainer; const firstCard = currentCardsContainer.querySelector('.date-card'); if (firstCard && firstCard.dataset.date !== 'New Date') { const addBtn = firstCard.querySelector('.add-topic-btn-card-single'); if (addBtn) addBtn.click(); } else if (firstCard) { showToastQueued('error', 'Set date for "New Date" card first.'); } else { showToastQueued('error', 'Add a card first.'); } return; }
             });

            // Cleanup on page unload
            window.addEventListener('beforeunload', window.cleanupAppListeners);
        }


        // ========================================================================
        // MODAL & DROPDOWN UTILITIES
        // ========================================================================
        function toggleDropdown(dropdownElement) { /* ... (unchanged) ... */ const button = dropdownElement.querySelector('.custom-dropdown-button'); const options = dropdownElement.querySelector('.custom-dropdown-options'); const isOpen = options.classList.contains('show'); closeAllDropdowns(); if (!isOpen) { options.classList.add('show'); button.classList.add('active'); } }
        function closeAllDropdowns() { /* ... (unchanged) ... */ document.querySelectorAll('.custom-dropdown-options.show').forEach(options => { options.classList.remove('show'); options.closest('.custom-dropdown').querySelector('.custom-dropdown-button').classList.remove('active'); }); }
        function selectDropdownOption(optionElement) { /* ... (unchanged) ... */ const dropdownElement = optionElement.closest('.custom-dropdown'); const button = dropdownElement.querySelector('.custom-dropdown-button'); const selectedValueSpan = button.querySelector('.selected-value'); const hiddenInput = document.getElementById(dropdownElement.dataset.targetInput); const value = optionElement.dataset.value; const text = optionElement.textContent; selectedValueSpan.textContent = text; hiddenInput.value = value; dropdownElement.querySelectorAll('.custom-dropdown-option').forEach(opt => opt.classList.remove('selected')); optionElement.classList.add('selected'); closeAllDropdowns(); }
        function setDropdownValue(dropdownElement, newValue) { /* ... (unchanged) ... */ const hiddenInput = document.getElementById(dropdownElement.dataset.targetInput); const options = dropdownElement.querySelectorAll('.custom-dropdown-option'); const buttonText = dropdownElement.querySelector('.selected-value'); let found = false; options.forEach(option => { option.classList.remove('selected'); if (option.dataset.value === newValue) { option.classList.add('selected'); buttonText.textContent = option.textContent; if(hiddenInput) hiddenInput.value = newValue; found = true; } }); if (!found && options.length > 0) { options[0].classList.add('selected'); buttonText.textContent = options[0].textContent; if(hiddenInput) hiddenInput.value = options[0].dataset.value; } else if (!found) { buttonText.textContent = 'Select...'; if(hiddenInput) hiddenInput.value = ''; } }
        function initDropdownDisplay(modalContainer) { /* ... (unchanged) ... */ modalContainer.querySelectorAll('.custom-dropdown').forEach(dropdown => { const selectedOption = dropdown.querySelector('.custom-dropdown-option.selected'); const buttonText = dropdown.querySelector('.selected-value'); const hiddenInput = document.getElementById(dropdown.dataset.targetInput); if (selectedOption) { buttonText.textContent = selectedOption.textContent; if(hiddenInput) hiddenInput.value = selectedOption.dataset.value; } else if (dropdown.querySelectorAll('.custom-dropdown-option').length > 0) { const firstOption = dropdown.querySelector('.custom-dropdown-option'); firstOption.classList.add('selected'); buttonText.textContent = firstOption.textContent; if(hiddenInput) hiddenInput.value = firstOption.dataset.value; } else { buttonText.textContent = 'Select...'; if(hiddenInput) hiddenInput.value = ''; } }); }
        function openModal(modalElement) { modalElement.classList.add('show'); }
        function closeModal(modalElement) { modalElement.classList.remove('show'); }

        // ========================================================================
        // CORE APP LOGIC (Handle Clicks, Saves, etc.)
        // ========================================================================
        function handleProgressClick(box, isReverse = false) { /* ... (code unchanged) ... */ }
        function handleEditClick(iconEl) { /* ... (code unchanged, ensure Bug 1 fallback is handled by getStudyTypeName/Class) ... */ }
        function handleAddTopicClick(button) { /* ... (code unchanged) ... */ }
        function handleModalAddSave() { /* ... (code unchanged) ... */ }
        function handleModalSave() { /* ... (code unchanged) ... */ }
        function handleModalDelete() { /* ... (code unchanged) ... */ }
        function addNewRow(tableId, dateString = "New Date") { /* ... (code unchanged) ... */ }
        function handleDeleteRowClick(button) { /* ... (code unchanged) ... */ }
        function handleDateChange(dateDiv) { /* ... (code unchanged) ... */ }
        function handleDragDrop(draggedElement, toSection) { /* ... (code unchanged) ... */ }
        function handleViewToggle(viewId) { /* ... (code unchanged) ... */ }
        function updateViewToggleUI() { /* ... (code unchanged) ... */ }


        // ========================================================================
        // PROGRESS UI & COUNTDOWN
        // ========================================================================

        function updateAllProgressUI() {
            updateOverallProgress();
            // updateTable2Progress(); // Removed
            updateAllCardProgressBars();
            updateTaskCounters();
        }
        function updateOverallProgress() { /* ... (code unchanged) ... */ }
        // function updateTable2Progress() { /* Removed */ }
        function updateTaskCounters() { /* ... (Update to only handle t1_task_counter) ... */
             const tableId = 'table1'; // Only target table
             const container = table1CardsContainer;
             const counterEl = document.getElementById('t1_task_counter');
             if (!container || !counterEl) return;
             const allBoxes = container.querySelectorAll('.progress-box');
             const totalTasks = allBoxes.length;
             let completedTasks = 0;
             allBoxes.forEach(box => { if (appData.completedTopics[box.dataset.topicId]?.progress === 100) completedTasks++; });
             counterEl.textContent = `${completedTasks} / ${totalTasks} Done`;
             counterEl.classList.remove('opacity-0');

            // Hide or clear t2 counter if it exists in HTML still
             const t2counter = document.getElementById('t2_task_counter');
             if(t2counter) t2counter.textContent = ''; // Clear it

        }
        function updateAllCardProgressBars() { /* ... (code unchanged) ... */ }
        function updateCardProgress(cardElement) { /* ... (code unchanged, ensure IDs are valid) ... */
             if (!cardElement) return;
             const tableId = cardElement.dataset.tableId, date = cardElement.dataset.date;
             if (!tableId || !date) return;
             const dateId = date.replace(/[\/ ]/g, '-'); // Ensure IDs match creation
             const bar = document.getElementById(`card-progress-bar-${tableId}-${dateId}`);
             const text = document.getElementById(`card-progress-text-${tableId}-${dateId}`);
             const count = document.getElementById(`card-progress-count-${tableId}-${dateId}`);
             if (!bar || !text || !count) { if (date !== "New Date") console.warn(`Progress elements missing for ${tableId}-${dateId}.`); return; }
             const allBoxes = cardElement.querySelectorAll('.progress-box');
             const totalTasks = allBoxes.length; let completedTasks = 0;
             allBoxes.forEach(box => { if (appData.completedTopics[box.dataset.topicId]?.progress === 100) completedTasks++; });
             const percentage = (totalTasks > 0) ? (completedTasks / totalTasks) * 100 : 0;
             bar.style.width = `${percentage}%`; text.textContent = `${Math.round(percentage)}%`; count.textContent = `${completedTasks} / ${totalTasks} Done`;
        }


        // ========================================================================
        // CALENDAR & COUNTDOWN
        // ========================================================================
        function handleGoToToday() { /* ... (code unchanged) ... */ }
        function handleOpenCalendar() { /* ... (code unchanged) ... */ }
        function renderCalendar(month, year) { /* ... (code unchanged) ... */ }
        function handleCalendarDateClick(dayElement) { /* ... (code unchanged) ... */ }

        // Updated Countdown Logic (No Circles)
        function startCountdown() {
            if (!countdownNameEl || !countdownEls.d) return; // Ensure elements exist

            countdownNameEl.textContent = appSettings.countdownName || DEFAULT_COUNTDOWN_NAME;
            const targetDateStr = appSettings.countdownDate || DEFAULT_COUNTDOWN_DATE;

            let countDownDate;
            try {
                 // Ensure time is set to start of the day for consistent calculation
                countDownDate = new Date(targetDateStr + "T00:00:00").getTime();
                 if (isNaN(countDownDate)) throw new Error("Invalid date format");
            } catch (e) {
                console.error("Invalid countdown date:", targetDateStr, e);
                countDownDate = new Date(DEFAULT_COUNTDOWN_DATE + "T00:00:00").getTime(); // Fallback
                 countdownNameEl.textContent += " (Default Date)";
            }


            const update = () => {
                if (!currentUserId) { // Stop if logged out
                   if(countdownInterval) clearInterval(countdownInterval);
                   ['d', 'h', 'm', 's'].forEach(k => { if(countdownEls[k]) countdownEls[k].textContent = "--"; });
                   return;
                 }

                const now = new Date().getTime();
                const dist = countDownDate - now;

                if (dist < 0) {
                    if (countdownInterval) clearInterval(countdownInterval);
                    ['d', 'h', 'm', 's'].forEach(k => { if(countdownEls[k]) countdownEls[k].textContent = "00"; });
                    return;
                }

                const d = Math.floor(dist / 864e5);
                const h = Math.floor((dist % 864e5) / 36e5);
                const m = Math.floor((dist % 36e5) / 6e4);
                const s = Math.floor((dist % 6e4) / 1e3);

                if(countdownEls.d) countdownEls.d.textContent = String(d).padStart(2, '0');
                if(countdownEls.h) countdownEls.h.textContent = String(h).padStart(2, '0');
                if(countdownEls.m) countdownEls.m.textContent = String(m).padStart(2, '0');
                if(countdownEls.s) countdownEls.s.textContent = String(s).padStart(2, '0');

            };

            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(update, 1000);
            update(); // Run immediately
        }
        // Removed updateCountdownCircles and setCircleProgress

        // ========================================================================
        // TOAST & CLEANUP
        // ========================================================================
        function showToastQueued(type, customMessage = '') { /* ... (code unchanged) ... */ }
        function processToastQueue() { /* ... (code unchanged) ... */ }

        // Ensure cleanup includes new timers/listeners if added
        window.cleanupAppListeners = () => {
             cleanupListenersAndState(); // Now calls the main cleanup function
        };
    </script>
</body>
                                                                                                                                                                                                                                                                                         </html>
